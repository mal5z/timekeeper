<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Billable">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Billable</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #D5D0C7;
    --surface: #FFFFFF;
    --surface-inset: #F8F7F5;
    --border: #C4BFB4;
    --border-light: #C4BFB4;
    --text: #2C2A25;
    --text-secondary: #6B665C;
    --text-muted: #A09A8E;
    --accent: #1B7A3D;
    --accent-light: #E8F5ED;
    --accent-mid: #2E9E55;
    --warning: #B8860B;
    --warning-light: #FDF6E3;
    --danger: #C53030;
    --danger-light: #FFF0F0;
    --blue: #2B5EA7;
    --blue-light: #EDF2FA;
    --radius: 14px;
    --radius-sm: 10px;
    --shadow-sm: 0 2px 4px rgba(44,42,37,0.12), 0 1px 2px rgba(44,42,37,0.08);
    --shadow-md: 0 4px 14px rgba(44,42,37,0.15), 0 2px 4px rgba(44,42,37,0.10);
    --shadow-lg: 0 10px 30px rgba(44,42,37,0.12), 0 2px 8px rgba(44,42,37,0.06);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --font: 'Source Sans 3', -apple-system, system-ui, sans-serif;
    --mono: 'IBM Plex Mono', 'SF Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: var(--font); background: var(--bg); color: var(--text);
    min-height: 100dvh; overflow-x: hidden; -webkit-font-smoothing: antialiased;
  }

  /* ===== NAV BAR ===== */
  .nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex; padding-bottom: var(--safe-bottom); z-index: 100;
    box-shadow: 0 -2px 10px rgba(44,42,37,0.05);
  }
  .nav-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px;
    padding: 10px 0 8px; background: none; border: none; color: var(--text-muted);
    font-family: var(--font); font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    text-transform: uppercase; cursor: pointer; transition: color 0.2s;
    position: relative;
  }
  .nav-btn.active { color: var(--accent); font-weight: 700; }
  .nav-btn.active::before {
    content: ''; position: absolute; top: 0; left: 20%; right: 20%;
    height: 3px; background: linear-gradient(90deg, var(--accent-mid), var(--accent)); border-radius: 0 0 3px 3px;
  }
  .nav-btn svg { width: 22px; height: 22px; }

  /* ===== HEADER ===== */
  .header {
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, var(--bg) 0%, var(--bg) 85%, rgba(213,208,199,0) 100%);
    padding: calc(var(--safe-top) + 16px) 20px 20px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .header h1 {
    font-size: 22px; font-weight: 700; letter-spacing: -0.4px; color: var(--text);
  }

  /* ===== SCREENS ===== */
  .screen { display: none; padding-bottom: calc(70px + var(--safe-bottom)); }
  .screen.active { display: block; }

  .timer-list { padding: 4px 14px 8px; }

  .section-label {
    font-size: 17px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;
    letter-spacing: 1px; padding: 16px 4px 10px; margin-top: 2px;
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    -webkit-user-select: none; user-select: none;
  }
  .section-label::before {
    content: ''; width: 7px; height: 7px; border-radius: 50%;
    background: var(--text-muted); flex-shrink: 0;
  }
  .section-label::after {
    content: '▾'; font-size: 30px; color: var(--text-muted); margin-left: auto;
    transition: transform 0.25s ease;
  }
  .section-label.collapsed::after { transform: rotate(-90deg); }
  .section-label.section-active::before { background: var(--accent); }
  .section-label.section-recent::before { background: var(--blue); }
  .section-label:first-child { padding-top: 4px; }
  .section-count {
    font-size: 14px; font-weight: 600; color: var(--text-secondary);
    background: var(--surface-inset); padding: 1px 8px; border-radius: 10px;
    letter-spacing: 0; text-transform: none;
  }

  /* ===== MATTER CARDS ===== */
  .matter-card {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); margin-bottom: 14px;
    box-shadow: var(--shadow-sm); transition: all 0.25s ease;
    border-left: 4px solid transparent;
    position: relative; overflow: hidden;
  }
  .matter-card.running {
    border-color: var(--accent); border-width: 1.5px;
    border-left: 4px solid var(--accent);
    background: linear-gradient(135deg, #f0faf3 0%, var(--surface) 100%);
    box-shadow: var(--shadow-md), 0 0 0 1.5px var(--accent-light);
  }
  .matter-card.menu-open { overflow: visible; }

  .swipe-wrap { position: relative; }
  .swipe-actions {
    position: absolute; right: 0; top: 0; bottom: 0;
    display: flex; align-items: stretch;
  }
  .swipe-action-btn {
    width: 64px; display: flex; flex-direction: column; align-items: center; justify-content: center;
    border: none; cursor: pointer; font-family: var(--font);
    font-size: 14px; font-weight: 700; color: white; gap: 2px;
  }
  .swipe-action-btn.sa-1 { background: var(--accent-mid); }
  .swipe-action-btn.sa-5 { background: var(--accent); }
  .swipe-action-btn.sa-10 { background: #14602F; }
  .swipe-action-btn.sa-last { background: var(--blue); }
  .swipe-action-btn.sa-stop1 { background: #E05353; }
  .swipe-action-btn.sa-stop5 { background: var(--danger); }
  .swipe-action-btn.sa-stop10 { background: #8B1A1A; }
  .swipe-action-btn span { font-size: 15px; font-weight: 800; }
  .swipe-content {
    position: relative; z-index: 1; background: var(--surface);
    transition: transform 0.25s ease;
  }
  .matter-card.running .swipe-content { background: linear-gradient(135deg, #f0faf3 0%, var(--surface) 100%); }


  .matter-row {
    padding: 14px 16px; user-select: none;
  }
  .matter-header {
    display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
    margin-bottom: 10px;
  }
  .matter-body {
    display: flex; align-items: center; gap: 14px;
  }

  .timer-toggle {
    width: 50px; height: 50px; border-radius: 50%; border: none;
    background: linear-gradient(145deg, #e8f5ed 0%, #d0ebd8 100%); color: var(--accent); display: flex;
    align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    transition: all 0.2s ease;
  }
  .timer-toggle:active { transform: scale(0.88); }
  .matter-card.running .timer-toggle {
    background: linear-gradient(145deg, #2E9E55 0%, #1B7A3D 100%); color: white;
    box-shadow: 0 3px 12px rgba(27,122,61,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 3px 12px rgba(27,122,61,0.35), inset 0 1px 0 rgba(255,255,255,0.2); }
    50% { box-shadow: 0 3px 16px rgba(27,122,61,0.5), 0 0 0 4px rgba(27,122,61,0.08), inset 0 1px 0 rgba(255,255,255,0.2); }
  }
  .timer-toggle svg { width: 20px; height: 20px; }

  .matter-info { flex: 1; min-width: 0; min-height: 44px; }
  .matter-name {
    font-size: 18px; font-weight: 700; color: var(--text);
    line-height: 1.3;
  }
  .matter-detail {
    font-size: 16px; font-weight: 700; color: var(--text-secondary);
    line-height: 1.4;
    font-family: var(--mono);
  }
  .matter-desc {
    font-size: 16px; color: var(--text-secondary); margin-top: 3px;
    line-height: 1.4;
  }
  .task-label {
    display: inline-block; font-size: 14px; font-weight: 700; color: var(--blue);
    background: var(--blue-light); padding: 2px 8px; border-radius: 10px;
    margin-top: 4px; letter-spacing: 0.2px;
  }
  .add-task-btn {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
    width: 28px; height: 28px; border-radius: 8px; display: flex;
    align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    transition: all 0.15s; margin-left: 8px;
  }
  .add-task-btn:active { background: var(--surface-inset); color: var(--text-secondary); }
  .add-task-btn svg { width: 14px; height: 14px; }

  .matter-card { position: relative; }
  .card-gear-wrap {
    position: relative; flex-shrink: 0;
  }
  .card-gear-btn {
    background: none; border: none; color: var(--text-secondary); cursor: pointer;
    padding: 4px; border-radius: 6px; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    opacity: 0.7;
  }
  .card-gear-btn:active { opacity: 1; background: var(--surface-inset); }
  .card-menu {
    position: absolute; right: 0; top: 100%; margin-top: 4px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); box-shadow: var(--shadow-md);
    z-index: 60; min-width: 170px; overflow: hidden;
  }
  .card-menu-item {
    display: block; width: 100%; text-align: left; background: none; border: none;
    padding: 12px 16px; font-size: 15px; font-weight: 600; color: var(--text);
    cursor: pointer; font-family: var(--font); transition: background 0.1s;
  }
  .card-menu-item:active { background: var(--surface-inset); }

  .matter-time {
    font-family: var(--mono); font-size: 20px; font-weight: 600;
    color: var(--text-secondary); flex-shrink: 0; text-align: right; line-height: 1.4;
    letter-spacing: -0.5px;
  }
  .matter-card.running .matter-time { color: var(--accent); }
  .matter-time .rounded-time {
    font-size: 16px; font-weight: 500; color: var(--text-secondary); display: block;
    letter-spacing: 0;
  }
  .matter-card.running .matter-time .rounded-time { color: var(--accent-mid); }

  /* ===== NARRATIVE PANEL ===== */
  .narrative-panel {
    padding: 0 16px 14px;
    background: var(--surface-inset);
    border-top: 1px solid #E8E5DF;
  }
  .narrative-input {
    width: 100%; min-height: 44px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: var(--font);
    font-size: 16px; line-height: 1.5; padding: 12px 14px; margin-top: 12px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-shadow: inset 0 1px 2px rgba(44,42,37,0.04);
    box-sizing: border-box; resize: none; overflow: hidden;
  }
  .narrative-input:focus {
    outline: none; border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light), inset 0 1px 2px rgba(44,42,37,0.04);
  }
  .narrative-input::placeholder { color: var(--text-muted); }

  .narrative-row { display: flex; gap: 10px; margin-top: 10px; align-items: center; justify-content: flex-end; }

  .btn {
    padding: 11px 18px; border-radius: var(--radius-sm); border: none;
    font-family: var(--font); font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.15s ease; display: flex; align-items: center; gap: 7px;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary {
    background: linear-gradient(145deg, #2E9E55 0%, #1B7A3D 100%); color: white; flex: 1;
    box-shadow: 0 2px 6px rgba(27,122,61,0.25), inset 0 1px 0 rgba(255,255,255,0.15);
  }
  .btn-primary:active { background: linear-gradient(145deg, #1B7A3D 0%, #14602F 100%); }
  .btn-secondary { background: var(--surface-inset); color: var(--text-secondary); border: 1px solid var(--border); }

  .intervals-toggle {
    background: var(--surface); border: 1px solid var(--border); color: var(--text-muted);
    width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex;
    align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    transition: all 0.2s;
  }
  .intervals-toggle:active { background: var(--surface-inset); }
  .intervals-toggle svg { width: 16px; height: 16px; transition: transform 0.25s ease; }
  .intervals-toggle.open { background: var(--surface-inset); }
  .intervals-toggle.open svg { transform: rotate(180deg); }

  /* ===== INTERVALS PANEL ===== */
  .intervals-panel {
    display: none; padding: 0 16px 16px;
    background: var(--surface-inset); border-top: 1px solid #E8E5DF;
  }
  .intervals-panel.open { display: block; }
  .intervals-header {
    font-size: 15px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;
    letter-spacing: 1px; padding: 12px 0 8px;
  }
  .interval-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 9px 0; border-bottom: 1px solid var(--border-light); font-size: 15px; gap: 8px;
  }
  .interval-item:last-child { border-bottom: none; }
  .interval-times { color: var(--text-secondary); flex: 1; }
  .interval-duration { font-family: var(--mono); font-size: 15px; color: var(--text-secondary); }
  .interval-edit-btn {
    background: none; border: none; color: var(--blue); cursor: pointer;
    padding: 4px 10px; font-size: 15px; font-weight: 600; font-family: var(--font);
  }
  .interval-live { color: var(--accent); font-style: italic; }

  .manual-adjust {
    display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 0 0;
    border-top: 1px solid var(--border-light); margin-top: 6px;
  }
  .manual-adjust-label { font-size: 15px; font-weight: 600; color: var(--text-secondary); flex-shrink: 0; }
  .adjust-step-btn {
    width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--surface-inset); color: var(--text); font-size: 18px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; flex-shrink: 0;
  }
  .adjust-step-btn:active { background: var(--border-light); transform: scale(0.92); }
  .adjust-display {
    font-family: var(--mono); font-size: 19px; font-weight: 600; color: var(--text);
    min-width: 55px; text-align: center; cursor: text;
    border-bottom: 1px dashed var(--border); padding: 2px 4px;
  }
  .adjust-display-input {
    font-family: var(--mono); font-size: 19px; font-weight: 600; color: var(--text);
    width: 65px; text-align: center; border: 1px solid var(--accent); border-radius: var(--radius-sm);
    padding: 2px 4px; background: #fff; outline: none;
  }
  .adjust-hint { font-size: 14px; color: var(--text-secondary); }

  /* ===== BADGES ===== */
  .saved-count {
    font-size: 13px; font-weight: 700; background: var(--accent-light); color: var(--accent);
    padding: 2px 8px; border-radius: 12px; margin-left: 6px; vertical-align: middle;
    letter-spacing: 0.2px;
  }
  .entry-edited {
    font-size: 13px; font-weight: 700; color: var(--warning); background: var(--warning-light);
    padding: 2px 8px; border-radius: 12px; margin-left: 6px; vertical-align: middle;
  }

  /* ===== TODAY SCREEN ===== */
  .today-header {
    padding: 4px 20px 14px; display: flex; justify-content: space-between; align-items: baseline;
  }
  .today-label { font-weight: 600; color: var(--text-secondary); font-size: 16px; }
  .today-total { font-family: var(--mono); font-size: 18px; color: var(--accent); font-weight: 600; }

  .entry-list { padding: 0 14px; }
  .entry-card {
    background: var(--surface); border: 1px solid var(--border-light);
    border-radius: var(--radius); padding: 18px; margin-bottom: 10px;
    box-shadow: var(--shadow-sm); border-left: 4px solid var(--accent);
    position: relative;
  }
  .entry-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .entry-matter { font-size: 19px; font-weight: 700; }
  .entry-time {
    font-family: var(--mono); font-size: 19px; color: var(--accent);
    font-weight: 600; flex-shrink: 0; margin-left: 12px;
  }
  .entry-narrative { font-size: 18px; color: var(--text-secondary); line-height: 1.55; }
  .entry-narrative.missing { color: var(--warning); font-style: italic; }

  .entry-actions { display: flex; gap: 8px; margin-top: 12px; }
  .entry-btn {
    background: var(--surface-inset); border: 1px solid var(--border); color: var(--text-secondary);
    font-family: var(--font); font-size: 16px; font-weight: 600; padding: 9px 16px;
    border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s;
  }
  .entry-btn:active { background: var(--border-light); }
  .entry-btn.delete { background: var(--danger-light); border-color: transparent; color: var(--danger); }

  /* ===== EDIT MODAL FIELDS ===== */
  .edit-section-label {
    font-size: 15px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase;
    letter-spacing: 1px; margin: 16px 0 8px;
  }
  .edit-section-label:first-child { margin-top: 0; }
  .edit-textarea {
    width: 100%; min-height: 80px; background: var(--surface-inset); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: var(--font);
    font-size: 16px; line-height: 1.5; padding: 12px 14px; resize: vertical;
    box-shadow: inset 0 1px 2px rgba(44,42,37,0.04);
  }
  .edit-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
  .edit-time-input {
    width: 100%; background: var(--surface-inset); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: var(--mono);
    font-size: 18px; padding: 12px 14px;
    box-shadow: inset 0 1px 2px rgba(44,42,37,0.04);
  }
  .edit-time-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
  .edit-interval-readonly {
    font-size: 15px; color: var(--text-secondary); padding: 6px 0;
    border-bottom: 1px solid var(--border-light);
  }
  .edit-interval-readonly:last-child { border-bottom: none; }
  .edit-interval-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
  }
  .edit-interval-row label {
    font-size: 14px; font-weight: 600; color: var(--text-secondary); width: 44px; flex-shrink: 0;
  }
  .edit-interval-row input {
    flex: 1; background: var(--surface-inset); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: var(--mono);
    font-size: 16px; padding: 10px 12px;
  }
  .edit-interval-row input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

  /* ===== EXPORT ===== */
  /* ===== SETTINGS ===== */
  .settings-section { padding: 4px 16px 16px; }
  .settings-section h2 {
    font-size: 17px; font-weight: 700; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding-top: 8px;
  }
  .matter-edit-list { display: flex; flex-direction: column; gap: 6px; }
  .matter-edit-item {
    background: var(--surface); border: 1px solid var(--border-light); border-radius: var(--radius-sm);
    padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-sm);
  }
  .matter-edit-info { flex: 1; min-width: 0; }
  .matter-edit-name { font-size: 16px; font-weight: 700; }
  .matter-edit-detail { font-size: 15px; color: var(--text-secondary); margin-top: 3px; }
  .delete-matter-btn {
    background: none; border: none; color: var(--text-muted); cursor: pointer;
    padding: 8px; border-radius: 8px;
  }
  .delete-matter-btn:active { color: var(--danger); background: var(--danger-light); }
  .add-matter-form {
    background: var(--surface); border: 1px solid var(--border-light);
    border-radius: var(--radius); padding: 16px; margin-top: 14px;
    box-shadow: var(--shadow-sm);
  }
  .add-matter-form input {
    width: 100%; background: var(--surface-inset); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-family: var(--font);
    font-size: 16px; padding: 12px 14px; margin-bottom: 10px;
    box-shadow: inset 0 1px 2px rgba(44,42,37,0.04);
  }
  .add-matter-form input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
  .add-matter-form input::placeholder { color: var(--text-muted); }
  .inc-btn.active { background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); }

  .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }

  .backup-status {
    font-size: 16px; color: var(--text-secondary); padding: 10px 14px;
    background: var(--surface-inset); border-radius: var(--radius-sm);
    margin-bottom: 12px; line-height: 1.5; display: none;
  }
  .backup-status.visible { display: block; }
  .backup-status.success { color: var(--accent); background: var(--accent-light); }
  .backup-status.error { color: var(--danger); background: var(--danger-light); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.35; }
  .empty-state p { font-size: 16px; line-height: 1.5; }

  /* ===== MODAL ===== */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(44,42,37,0.25);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    z-index: 200; align-items: center; justify-content: center; padding: 24px;
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border-light);
    border-radius: 18px; padding: 26px; max-width: 370px; width: 100%;
    max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg);
  }
  .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 14px; letter-spacing: -0.2px; }
  .modal p { font-size: 16px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
  .modal-buttons { display: flex; gap: 10px; margin-top: 18px; }
  .modal-buttons .btn { flex: 1; justify-content: center; padding: 13px; }
  .btn-danger {
    background: var(--danger); color: white;
    box-shadow: 0 1px 3px rgba(197,48,48,0.2);
  }

  ::-webkit-scrollbar { width: 0; }
</style>
</head>
<body>

<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Confirm</h3>
    <div id="modalBody"><p id="modalMsg"></p></div>
    <div class="modal-buttons" id="modalButtons">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<div class="header">
  <h1 id="screenTitle">Timers</h1>
  <button id="addMatterBtn" onclick="openAddMatter()" style="background:linear-gradient(145deg, #2E9E55 0%, #1B7A3D 100%);border:none;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:white;flex-shrink:0;box-shadow:0 2px 8px rgba(27,122,61,0.3)">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>
</div>

<div class="screen active" id="timersScreen">
  <div id="dayTotalBar" style="padding:10px 18px;text-align:center;font-family:var(--font)">
    <span style="font-size:17px;color:var(--text-secondary);font-weight:600">Today </span>
    <span id="dayTotalValue" style="font-family:var(--mono);font-size:17px;color:var(--accent);font-weight:700">0.00 h</span>
  </div>
  <div class="timer-list" id="timerList"></div>
</div>

<div class="screen" id="todayScreen">
  <div id="entryList" style="padding:0 14px"></div>
</div>

<div class="screen" id="settingsScreen">
  <div class="settings-section">
    <h2>Local Backup</h2>
    <div class="add-matter-form" style="margin-top:0">
      <div class="backup-status" id="backupStatus"></div>
      <div style="font-size:16px;color:var(--text-secondary);margin-bottom:12px;line-height:1.5">Rolling snapshots every 5 minutes and hourly snapshots kept for 48 hours — all automatic.</div>
      <button class="btn btn-secondary" style="width:100%;justify-content:center;font-size:15px" onclick="restoreAutoBackup()">View Backup Snapshots</button>
    </div>
  </div>
  <div class="settings-section">
    <h2>Cloud Backup (Dropbox)</h2>
    <div class="add-matter-form" style="margin-top:0">
      <div class="backup-status" id="cloudStatus"></div>
      <div id="cloudConnected" style="display:none">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);flex-shrink:0"></div>
          <span style="font-size:16px;font-weight:600;color:var(--accent)">Connected to Dropbox</span>
        </div>
        <div style="font-size:16px;color:var(--text-secondary);margin-bottom:12px;line-height:1.5" id="cloudLastSync">Hourly backups: text (48h) + full data snapshots (48h hourly, then daily for 14 days).</div>
        <button class="btn btn-secondary" style="width:100%;justify-content:center;margin-bottom:8px;font-size:14px" onclick="cloudUploadNow()">Upload Now</button>
        <button class="btn btn-secondary" style="width:100%;justify-content:center;margin-bottom:8px;font-size:14px" onclick="cloudRestore()">Restore from Cloud</button>
        <button class="btn btn-secondary" style="width:100%;justify-content:center;font-size:15px;color:var(--danger);border-color:var(--danger-light)" onclick="cloudDisconnect()">Disconnect Dropbox</button>
      </div>
      <div id="cloudSetup">
        <div style="font-size:16px;color:var(--text-secondary);line-height:1.6;margin-bottom:14px">
          Connect to Dropbox to back up your data or restore from an existing backup.
        </div>
        <details style="margin-bottom:14px">
          <summary style="font-size:16px;font-weight:600;color:var(--blue);cursor:pointer;margin-bottom:8px">Restoring? Find your existing App Key</summary>
          <ol style="font-size:16px;color:var(--text-secondary);line-height:1.7;padding-left:20px;margin-top:8px">
            <li>Go to <strong>dropbox.com/developers/apps</strong></li>
            <li>Click your existing app (e.g., "TimeKeep")</li>
            <li>On the <strong>Settings</strong> tab, copy the <strong>App key</strong></li>
            <li>Paste it below and connect — your backups will appear automatically</li>
          </ol>
        </details>
        <details style="margin-bottom:14px">
          <summary style="font-size:16px;font-weight:600;color:var(--blue);cursor:pointer;margin-bottom:8px">First time? Create a Dropbox App (3 min)</summary>
          <ol style="font-size:16px;color:var(--text-secondary);line-height:1.7;padding-left:20px;margin-top:8px">
            <li>Go to <strong>dropbox.com/developers/apps</strong></li>
            <li>Click <strong>Create app</strong></li>
            <li>Choose <strong>Scoped access</strong> → <strong>App folder</strong></li>
            <li>Name it anything (e.g., "TimeKeep")</li>
            <li>Go to the <strong>Permissions</strong> tab</li>
            <li>Check <strong>files.content.write</strong> and <strong>files.content.read</strong></li>
            <li>Click <strong>Submit</strong> on the permissions page</li>
            <li>Go back to the <strong>Settings</strong> tab</li>
            <li>Copy the <strong>App key</strong> and paste it below</li>
          </ol>
        </details>
        <label style="font-size:15px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px">Dropbox App Key</label>
        <input type="text" id="cloudAppKey" placeholder="Paste your Dropbox App Key" autocomplete="off">
        <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="cloudConnect()">Connect Dropbox</button>
      </div>
    </div>
  </div>
  <div style="text-align:center;padding:20px 0 10px;font-size:12px;color:var(--text-muted);letter-spacing:0.5px">Billable v0.10</div>
</div>

<div class="nav">
  <button class="nav-btn active" onclick="switchScreen('timers')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Timers
  </button>
  <button class="nav-btn" onclick="switchScreen('today')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Entries
  </button>
  <button class="nav-btn" onclick="switchScreen('settings')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    Settings
  </button>
</div>

<script>
const DEFAULT_MATTERS = [
  { id: 'm1', name: 'Sample Client', clientNumber: '000000', matterNumber: '00010', matterName: 'General Corporate', increment: 0.10 },
  { id: 'm2', name: 'Sample Client', clientNumber: '000000', matterNumber: '00020', matterName: 'Litigation', increment: 0.25 },
];

function loadData(key, fb) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fb; } catch { return fb; } }
function saveData(key, d) { localStorage.setItem(key, JSON.stringify(d)); }

let matters = loadData('tk_matters', DEFAULT_MATTERS);
let timers = loadData('tk_timers', {});
let entries = loadData('tk_entries', []);
let openIntervals = {};
let cachedRecentIds = new Set();
let cachedRestIds = new Set();

matters.forEach(m => {
  if (!timers[m.id]) timers[m.id] = { running: false, narrative: '', intervals: [], manualAdjustMs: 0, lastUsed: 0 };
  const t = timers[m.id];
  if (!t.intervals) { const old = t.elapsed||0; t.intervals = old>0?[{start:Date.now()-old,end:Date.now()}]:[]; t.manualAdjustMs=0; delete t.elapsed; delete t.startedAt; }
  if (t.manualAdjustMs === undefined) t.manualAdjustMs = 0;
  if (t.lastUsed === undefined) t.lastUsed = 0;
});
saveData('tk_timers', timers);

function recomputeSections() {
  const cutoff = Date.now() - 7*24*60*60*1000;
  cachedRecentIds = new Set(); cachedRestIds = new Set();
  matters.forEach(m => {
    const t = timers[m.id];
    if (t && t.excludeRecent) { cachedRestIds.add(m.id); return; }
    const isRecent = (t&&t.lastUsed&&t.lastUsed>cutoff) || entries.some(e=>e.matterId===m.id&&e.timestamp>cutoff);
    (isRecent ? cachedRecentIds : cachedRestIds).add(m.id);
  });
}

function getElapsed(mid) {
  const t=timers[mid]; if(!t) return 0;
  let total=0; t.intervals.forEach(iv=>{total+=(iv.end||Date.now())-iv.start;});
  return Math.max(0, total+(t.manualAdjustMs||0));
}

function fmt(ms) {
  const s=Math.floor(Math.max(0,ms)/1000);
  return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor(s%3600/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

function roundInc(ms, inc) {
  if(ms<=0) return 0;
  const adj=ms-60000, h=adj/3600000, raw=Math.ceil(h/inc)*inc;
  return Math.max(0, raw);
}
function fmtRound(ms, inc) { return roundInc(ms,inc).toFixed(2); }

function fmtClock(ts) {
  const d=new Date(ts); let h=d.getHours(); const ap=h>=12?'PM':'AM'; h=h%12||12;
  return `${h}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')} ${ap}`;
}

function fmtDur(ms) {
  const s=Math.floor(ms/1000), m=Math.floor(s/60);
  if(m>=60) return `${Math.floor(m/60)}h ${m%60}m`;
  return `${m}m ${s%60}s`;
}


function toggleTimer(mid, e) {
  if(e) e.stopPropagation();
  const t=timers[mid];
  const wasInRest = cachedRestIds.has(mid);
  const wasRunning = t.running;
  if(t.running) { const iv=t.intervals.find(i=>!i.end); if(iv) iv.end=Date.now(); t.running=false; }
  else {
    Object.keys(timers).forEach(id=>{ if(id!==mid&&timers[id].running){ const iv=timers[id].intervals.find(i=>!i.end); if(iv) iv.end=Date.now(); timers[id].running=false; }});
    t.intervals.push({start:Date.now(),end:null}); t.running=true; t.lastUsed=Date.now(); delete t.excludeRecent;
  }
  saveData('tk_timers',timers);
  if (wasInRest && t.running) {
    recomputeSections();
  }
  // Use FLIP animation when starting a timer (reorder or section change may happen)
  if (!wasRunning && t.running) {
    flipRenderTimers();
  } else {
    renderTimers();
  }
}

function saveEntry(mid) {
  const t=timers[mid], m=matters.find(x=>x.id===mid), el=getElapsed(mid);
  if(el<1000) return;
  if(t.running){ const iv=t.intervals.find(i=>!i.end); if(iv) iv.end=Date.now(); t.running=false; }
  // Calculate total from raw intervals only
  let rawMs = 0;
  t.intervals.forEach(iv => { rawMs += (iv.end || Date.now()) - iv.start; });
  const adjMs = t.manualAdjustMs || 0;
  const totalMs = Math.max(0, rawMs + adjMs);
  const inc = m.increment || 0.10;
  const numberLine = [m.clientNumber, m.matterNumber].filter(Boolean).join('-');
  entries.push({ id:'e'+Date.now(), matterId: m.taskLabel ? (m.parentId || mid) : mid,
    matterName:m.name, matterDetail:m.detail, clientNumber: m.clientNumber||'', matterNumber: m.matterNumber||'',
    billingNumber: numberLine, taskLabel: m.taskLabel||'',
    hours:fmtRound(totalMs,inc), ms:totalMs, rawMs: rawMs, adjustMs: adjMs, increment:inc,
    narrative:t.narrative.trim(), intervals:[...t.intervals], timestamp: t.intervals[0]?.start || Date.now() });
  t.intervals=[]; t.manualAdjustMs=0; t.narrative='';
  saveData('tk_timers',timers); saveData('tk_entries',entries);
  openIntervals[mid]=false;

  // Auto-remove spawned task timers after saving
  if (m.taskLabel) {
    matters = matters.filter(x => x.id !== mid);
    delete timers[mid];
    saveData('tk_matters', matters);
    saveData('tk_timers', timers);
  }

  recomputeSections(); renderTimers();
  autoBackup();
}

// Section collapse state
const COLLAPSED_KEY = 'tk_collapsed';
let sectionAnimating = false;
function getCollapsedSections() { return loadData(COLLAPSED_KEY, {}); }
function isSectionCollapsed(key) { return !!getCollapsedSections()[key]; }
function toggleSection(key, headerEl) {
  const state = getCollapsedSections();
  state[key] = !state[key];
  saveData(COLLAPSED_KEY, state);
  headerEl.classList.toggle('collapsed', state[key]);
  const chev = headerEl.querySelector('[data-chevron]');
  if (chev) chev.style.transform = state[key] ? 'rotate(-90deg)' : '';

  const content = headerEl.nextElementSibling;
  if (!content || !content.classList.contains('section-content')) return;

  sectionAnimating = true;
  if (state[key]) {
    content.style.maxHeight = content.scrollHeight + 'px';
    content.style.overflow = 'hidden';
    content.offsetHeight;
    content.style.transition = 'max-height 0.3s ease';
    content.style.maxHeight = '0';
    const onEnd = () => {
      content.removeEventListener('transitionend', onEnd);
      content.style.display = 'none';
      content.style.transition = '';
      content.style.maxHeight = '';
      content.style.overflow = '';
      sectionAnimating = false;
    };
    content.addEventListener('transitionend', onEnd);
  } else {
    content.style.display = '';
    content.style.maxHeight = '0';
    content.style.overflow = 'hidden';
    content.offsetHeight;
    content.style.transition = 'max-height 0.3s ease';
    content.style.maxHeight = content.scrollHeight + 'px';
    const onEnd = () => {
      content.removeEventListener('transitionend', onEnd);
      content.style.transition = '';
      content.style.maxHeight = '';
      content.style.overflow = '';
      sectionAnimating = false;
    };
    content.addEventListener('transitionend', onEnd);
  }
  // Safety timeout in case transitionend doesn't fire
  setTimeout(() => { sectionAnimating = false; }, 1100);
}

function renderTimers() {
  if (sectionAnimating) return;
  const list=document.getElementById('timerList');
  // Hide parent matters that have zero time when active spawned tasks exist
  const activeSpawnParents = new Set(matters.filter(m=>m.taskLabel&&m.parentId).map(m=>m.parentId));
  function shouldShow(m) {
    if (!activeSpawnParents.has(m.id)) return true;
    const el = getElapsed(m.id);
    const narr = (timers[m.id]?.narrative||'').trim();
    return el > 0 || narr;
  }
  const recent=matters.filter(m=>cachedRecentIds.has(m.id)&&shouldShow(m)).sort((a,b)=>{
    const ta=timers[a.id], tb=timers[b.id];
    if(ta?.running && !tb?.running) return -1;
    if(!ta?.running && tb?.running) return 1;
    return (tb?.lastUsed||0) - (ta?.lastUsed||0);
  });
  const rest=matters.filter(m=>cachedRestIds.has(m.id)&&shouldShow(m)).sort((a,b)=>a.name.localeCompare(b.name));

  function renderCard(m, isRecent) {
    const t=timers[m.id], el=getElapsed(m.id), isRun=t?.running;
    const inc=m.increment||0.10;
    const countId = m.taskLabel ? (m.parentId || m.id) : m.id;
    const saved=entries.filter(e=>e.matterId===countId&&isToday(e.timestamp)).length;

    // Build display lines
    let numberLine = '';
    if (m.clientNumber || m.matterNumber) {
      numberLine = [m.clientNumber, m.matterNumber].filter(Boolean).join('-');
    } else if (m.detail) {
      // Legacy: try to extract number from parens
      const match = m.detail.match(/\(([^)]+)\)/);
      numberLine = match ? match[1] : '';
    }
    let descLine = m.matterName || '';
    if (!descLine && m.detail) {
      // Legacy: use detail minus the number in parens
      descLine = m.detail.replace(/\s*\([^)]+\)\s*/, '').trim();
    }
    const isOpen=openIntervals[m.id];
    const completed=(t?.intervals||[]).filter(iv=>iv.end), live=(t?.intervals||[]).find(iv=>!iv.end);
    const adjH=(t?.manualAdjustMs||0)/3600000, adjD=adjH.toFixed(2);

    let ivHtml='';
    if(isOpen){
      let items='';
      completed.forEach((iv,idx)=>{
        items+=`<div class="interval-item"><span class="interval-times">${fmtClock(iv.start)} – ${fmtClock(iv.end)}</span><span class="interval-duration">${fmtDur(iv.end-iv.start)}</span><button class="interval-edit-btn" onclick="editInterval('${m.id}',${idx})">Edit</button></div>`;
      });
      if(live) items+=`<div class="interval-item interval-live"><span class="interval-times">${fmtClock(live.start)} – now</span><span class="interval-duration">running</span><span></span></div>`;
      if(!completed.length&&!live) items='<div style="font-size:14px;color:var(--text-secondary);padding:10px 0">No intervals yet</div>';
      ivHtml=`<div class="intervals-panel open"><div class="intervals-header">Intervals</div>${items}<div class="manual-adjust"><span class="manual-adjust-label">Adjust</span><button class="adjust-step-btn" onclick="stepAdjust('${m.id}',-${inc})">−</button><span class="adjust-display" id="adjDisp_${m.id}" onclick="directEditAdjust('${m.id}',${inc})">${adjD}</span><button class="adjust-step-btn" onclick="stepAdjust('${m.id}',${inc})">+</button><span class="adjust-hint">hours</span></div><div style="text-align:right;padding-top:8px;border-top:1px solid var(--border);margin-top:10px"><button onclick="discardTimer('${m.id}')" style="background:none;border:none;color:var(--danger);font-size:15px;font-weight:600;cursor:pointer;padding:4px 0">Discard Time Entries</button></div></div>`;
    }

    const menuItems = `
      <button onclick="this.closest('.card-menu').style.display='none';editMatter('${m.id}')" class="card-menu-item">Edit Matter</button>
      ${isRecent ? `<button onclick="this.closest('.card-menu').style.display='none';removeFromRecent('${m.id}')" class="card-menu-item">Remove from Recent</button>` : ''}`;

    // Find most recent interval end across all timers (excluding this matter)
    let lastStopBtn = '';
    if (!isRun) {
      let lastEnd = 0;
      Object.keys(timers).forEach(id => {
        if (id === m.id) return;
        (timers[id].intervals || []).forEach(iv => {
          if (iv.end && iv.end > lastEnd) lastEnd = iv.end;
        });
      });
      // Also check saved entries for recent stop times
      entries.forEach(e => {
        if (e.intervals) e.intervals.forEach(iv => {
          if (iv.end && iv.end > lastEnd) lastEnd = iv.end;
        });
      });
      if (lastEnd > 0) {
        const ago = Date.now() - lastEnd;
        if (ago < 24 * 60 * 60 * 1000) { // only show if within 24h
          const t2 = new Date(lastEnd);
          let h = t2.getHours(), ap = h >= 12 ? 'p' : 'a'; h = h % 12 || 12;
          const timeLabel = `${h}:${String(t2.getMinutes()).padStart(2,'0')}${ap}`;
          lastStopBtn = `<button class="swipe-action-btn sa-last" onclick="startAt('${m.id}',${lastEnd})"><span>${timeLabel}</span>last stop</button>`;
        }
      }
    }

    return `<div class="matter-card ${isRun?'running':''}" data-id="${m.id}">
      <div class="swipe-wrap">
        <div class="swipe-actions">
          ${isRun ? `
          <button class="swipe-action-btn sa-stop1" onclick="stopBackdated('${m.id}',1)"><span>1</span>min ago</button>
          <button class="swipe-action-btn sa-stop5" onclick="stopBackdated('${m.id}',5)"><span>5</span>min ago</button>
          <button class="swipe-action-btn sa-stop10" onclick="stopBackdated('${m.id}',10)"><span>10</span>min ago</button>
          ` : `
          <button class="swipe-action-btn sa-1" onclick="startBackdated('${m.id}',1)"><span>1</span>min ago</button>
          <button class="swipe-action-btn sa-5" onclick="startBackdated('${m.id}',5)"><span>5</span>min ago</button>
          <button class="swipe-action-btn sa-10" onclick="startBackdated('${m.id}',10)"><span>10</span>min ago</button>
          ${lastStopBtn}
          `}
        </div>
      <div class="swipe-content" ontouchstart="swipeStart(event)" ontouchmove="swipeMove(event,'${m.id}')" ontouchend="swipeEnd(event,'${m.id}')">
      <div class="matter-row">
        <div class="matter-header">
          <div class="matter-name" onclick="editMatter('${m.id}')" style="cursor:pointer">${m.name}</div>
          <div class="card-gear-wrap">
            <button onclick="toggleCardMenu(this)" class="card-gear-btn">
              <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            </button>
            <div class="card-menu" style="display:none">${menuItems}</div>
          </div>
        </div>
        <div class="matter-body">
          <button class="timer-toggle" onclick="toggleTimer('${m.id}',event)">
            ${isRun?'<svg fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>':'<svg fill="currentColor" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>'}
          </button>
          <div class="matter-info" onclick="editMatter('${m.id}')" style="cursor:pointer">
            ${numberLine ? `<div class="matter-detail">${numberLine}</div>` : ''}
            ${descLine ? `<div class="matter-desc">${descLine}</div>` : ''}
          </div>
          <div class="matter-time" data-timer="${m.id}" data-inc="${inc}" data-saved="${saved}">
            <span class="timer-hms">${fmt(el)}</span><span class="rounded-time">${fmtRound(el,inc)} h</span><span style="display:block;font-size:15px;font-weight:600;font-family:var(--font);min-height:1.2em;${saved?'color:var(--accent-mid)':'visibility:hidden'}">${saved ? saved+' saved' : '&nbsp;'}</span>
          </div>
        </div>
      </div>
      </div></div>
      ${(el > 0 || isRun || (t?.narrative||'').trim()) ? `<div class="narrative-panel">
        <textarea class="narrative-input" rows="1" placeholder="Paste narrative here..." oninput="updateNarr('${m.id}',this.value);autoGrow(this)" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}" onblur="stripPeriod(this,'${m.id}')" onfocus="autoGrow(this)">${t?.narrative||''}</textarea>
        <div class="narrative-row">
          <button onclick="saveEntry('${m.id}')" style="background:none;border:1px solid var(--border);color:var(--text-secondary);font-size:15px;font-weight:600;cursor:pointer;padding:7px 12px;border-radius:var(--radius-sm)">Save Entry</button>
          <button onclick="spawnTask('${m.parentId||m.id}','${m.id}',event)" style="background:none;border:1px solid var(--border);color:var(--text-secondary);font-size:15px;font-weight:600;cursor:pointer;padding:7px 12px;border-radius:var(--radius-sm)">+ Task</button>
          <button class="intervals-toggle ${isOpen?'open':''}" onclick="toggleIv('${m.id}')">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
        </div>
      </div>` : ''}
      ${(el > 0 || isRun) ? ivHtml : ''}
    </div>`;
  }

  let html='';
  if(recent.length>0){ 
    const rc = isSectionCollapsed('recent');
    html+=`<div class="section-label section-recent${rc?' collapsed':''}" onclick="toggleSection('recent',this)">Recent <span class="section-count">${recent.length}</span></div>`;
    html+=`<div class="section-content"${rc?' style="display:none"':''}>`;
    html+=recent.map(m=>renderCard(m,true)).join('');
    html+='</div>';
  }
  if(rest.length>0){ 
    const ac = isSectionCollapsed('allMatters');
    html+=`<div class="section-label${ac?' collapsed':''}" onclick="toggleSection('allMatters',this)">All Matters <span class="section-count">${rest.length}</span></div>`;
    html+=`<div class="section-content"${ac?' style="display:none"':''}>`;
    html+=rest.map(m=>renderCard(m,false)).join('');
    html+='</div>';
  }
  list.innerHTML=html;
  list.querySelectorAll('.narrative-input').forEach(el=>{if(el.value)autoGrow(el);});
}

// FLIP animation for reordering cards
function flipRenderTimers() {
  const list = document.getElementById('timerList');
  // First: capture current positions
  const firstRects = {};
  list.querySelectorAll('.matter-card[data-id]').forEach(card => {
    firstRects[card.dataset.id] = card.getBoundingClientRect();
  });
  
  // Execute: re-render (bypass sectionAnimating guard)
  const wasAnimating = sectionAnimating;
  sectionAnimating = false;
  renderTimers();
  
  // Last: capture new positions and Invert+Play
  let hasAnimation = false;
  let maxDuration = 0;
  list.querySelectorAll('.matter-card[data-id]').forEach(card => {
    const id = card.dataset.id;
    const first = firstRects[id];
    if (!first) return;
    const last = card.getBoundingClientRect();
    const deltaY = first.top - last.top;
    if (Math.abs(deltaY) < 2) return;
    hasAnimation = true;
    card.style.transform = `translateY(${deltaY}px)`;
    card.style.zIndex = deltaY > 0 ? '10' : '1';
    card.style.transition = 'none';
    // Scale duration: 400ms base + more for longer distances, capped at 1.6s
    const dist = Math.abs(deltaY);
    const duration = Math.min(1.6, 0.4 + dist / 500);
    maxDuration = Math.max(maxDuration, duration);
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        card.style.transition = `transform ${duration}s cubic-bezier(0.22, 0.61, 0.36, 1)`;
        card.style.transform = '';
        card.addEventListener('transitionend', function cleanup() {
          card.style.transition = '';
          card.style.zIndex = '';
          card.removeEventListener('transitionend', cleanup);
        });
      });
    });
  });
  
  // Lock tick renders during animation
  if (hasAnimation) {
    sectionAnimating = true;
    setTimeout(() => { sectionAnimating = false; }, (maxDuration * 1000) + 100);
  }
}

function toggleIv(mid){openIntervals[mid]=!openIntervals[mid];renderTimers();}
function updateNarr(mid,v){timers[mid].narrative=v;saveData('tk_timers',timers);}
function stripPeriod(el,mid){const v=el.value.replace(/\.+$/,'');if(v!==el.value){el.value=v;updateNarr(mid,v);}}
function autoGrow(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}
function setAdjust(mid,h){timers[mid].manualAdjustMs=(parseFloat(h)||0)*3600000;saveData('tk_timers',timers);}
function stepAdjust(mid,delta){
  const t=timers[mid]; const cur=(t.manualAdjustMs||0)/3600000;
  const next=Math.round((cur+delta)*100)/100;
  t.manualAdjustMs=next*3600000; saveData('tk_timers',timers);
  const disp=document.getElementById('adjDisp_'+mid);
  if(disp) disp.textContent=next.toFixed(2);
}

function directEditAdjust(mid, inc) {
  const disp = document.getElementById('adjDisp_'+mid);
  if (!disp) return;
  const cur = disp.textContent;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = inc.toFixed(2);
  input.value = cur;
  input.className = 'adjust-display-input';
  input.inputMode = 'decimal';
  disp.replaceWith(input);
  input.focus();
  input.select();
  const commit = () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = 0;
    val = Math.round(val * 100) / 100;
    const t = timers[mid];
    if (t) { t.manualAdjustMs = val * 3600000; saveData('tk_timers', timers); }
    const span = document.createElement('span');
    span.className = 'adjust-display';
    span.id = 'adjDisp_' + mid;
    span.textContent = val.toFixed(2);
    span.onclick = () => directEditAdjust(mid, inc);
    input.replaceWith(span);
  };
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } });
}

function toggleCardMenu(btn) {
  const menu = btn.nextElementSibling;
  const wasOpen = menu.style.display !== 'none';
  // Close all card menus first
  document.querySelectorAll('.card-menu').forEach(m => m.style.display = 'none');
  document.querySelectorAll('.matter-card.menu-open').forEach(c => c.classList.remove('menu-open'));
  if (!wasOpen) {
    menu.style.display = 'block';
    btn.closest('.matter-card').classList.add('menu-open');
  }
}

function removeFromRecent(mid) {
  const t = timers[mid];
  if (t) { t.excludeRecent = true; saveData('tk_timers', timers); }
  recomputeSections();
  renderTimers();
}

// Swipe-to-backdate
let swipeStartX = 0, swipeStartY = 0, swiping = false, swipeEl = null;
const SWIPE_THRESHOLD = 60;

function getSwipeMax(el) {
  const actions = el.closest('.swipe-wrap')?.querySelector('.swipe-actions');
  return actions ? actions.scrollWidth : 192;
}

function swipeStart(e) {
  const touch = e.touches[0];
  swipeStartX = touch.clientX;
  swipeStartY = touch.clientY;
  swiping = false;
  swipeEl = e.currentTarget;
  swipeEl.style.transition = 'none';
}

function swipeMove(e, mid) {
  if (!swipeEl) return;
  const touch = e.touches[0];
  const dx = swipeStartX - touch.clientX;
  const dy = Math.abs(touch.clientY - swipeStartY);
  // If vertical scrolling, bail
  if (!swiping && dy > 15) { swipeEl = null; return; }
  if (dx > 10) swiping = true;
  if (!swiping) return;
  e.preventDefault();
  const max = getSwipeMax(swipeEl);
  const offset = Math.max(0, Math.min(max, dx));
  swipeEl.style.transform = `translateX(-${offset}px)`;
}

function swipeEnd(e, mid) {
  if (!swipeEl) return;
  swipeEl.style.transition = 'transform 0.25s ease';
  const touch = e.changedTouches[0];
  const dx = swipeStartX - touch.clientX;
  const max = getSwipeMax(swipeEl);
  if (dx > SWIPE_THRESHOLD) {
    swipeEl.style.transform = `translateX(-${max}px)`;
    // Auto-close after 5 seconds if not tapped
    const el = swipeEl;
    setTimeout(() => { if (el.style.transform !== 'translateX(0px)') { el.style.transform = 'translateX(0px)'; }}, 5000);
  } else {
    swipeEl.style.transform = 'translateX(0px)';
  }
  swipeEl = null; swiping = false;
}

function closeAllSwipes() {
  document.querySelectorAll('.swipe-content').forEach(el => {
    el.style.transition = 'transform 0.25s ease';
    el.style.transform = 'translateX(0px)';
  });
}

function startBackdated(mid, minutes) {
  closeAllSwipes();
  const now = Date.now();
  const startTime = now - (minutes * 60000);
  startTimerAt(mid, startTime);
}

function startAt(mid, timestamp) {
  closeAllSwipes();
  startTimerAt(mid, timestamp);
}

function startTimerAt(mid, startTime) {
  const now = Date.now();

  // Stop any running timer and trim it
  Object.keys(timers).forEach(id => {
    if (id !== mid && timers[id].running) {
      const iv = timers[id].intervals.find(i => !i.end);
      if (iv) {
        iv.end = Math.max(iv.start, startTime);
      }
      timers[id].running = false;
    }
  });

  // Start the new timer at the given time
  const t = timers[mid];
  t.intervals.push({ start: startTime, end: null });
  t.running = true;
  t.lastUsed = now;
  delete t.excludeRecent;

  const wasInRest = cachedRestIds.has(mid);
  saveData('tk_timers', timers);
  recomputeSections();
  flipRenderTimers();
}

function stopBackdated(mid, minutes) {
  closeAllSwipes();
  const stopTime = Date.now() - (minutes * 60000);
  const t = timers[mid];
  const iv = t.intervals.find(i => !i.end);
  if (iv) {
    iv.end = Math.max(iv.start, stopTime);
  }
  t.running = false;
  saveData('tk_timers', timers);
  renderTimers();
}

function discardTimer(mid) {
  const m = matters.find(x => x.id === mid);
  const label = m ? m.name : 'this timer';
  showModal('Discard Time Entries', `Discard all time on ${label}? This can't be undone.`, () => {
    const t = timers[mid];
    if (t) {
      if (t.running) { t.running = false; }
      t.intervals = [];
      t.manualAdjustMs = 0;
      t.narrative = '';
    }
    openIntervals[mid] = false;

    // If it's a spawned task, remove the matter entirely
    if (m && m.taskLabel) {
      matters = matters.filter(x => x.id !== mid);
      delete timers[mid];
      saveData('tk_matters', matters);
    }

    saveData('tk_timers', timers);
    recomputeSections();
    renderTimers();
  });
}

function spawnTask(mid, sourceId, e) {
  if (e) e.stopPropagation();
  const m = matters.find(x => x.id === mid);
  if (!m) return;

  // Pause the source timer (the one the user clicked from)
  const st = timers[sourceId];
  if (st && st.running) {
    const iv = st.intervals.find(i => !i.end);
    if (iv) iv.end = Date.now();
    st.running = false;
    saveData('tk_timers', timers);
  }

  const newId = 'm' + Date.now();
  const clone = {
    id: newId,
    name: m.name,
    detail: m.detail,
    clientName: m.clientName || '',
    clientNumber: m.clientNumber || '',
    matterName: m.matterName || '',
    matterNumber: m.matterNumber || '',
    increment: m.increment,
    taskLabel: true,
    parentId: mid
  };

  matters.push(clone);
  timers[newId] = { running: true, narrative: '', intervals: [{ start: Date.now(), end: null }], manualAdjustMs: 0, lastUsed: Date.now() };
  saveData('tk_matters', matters);
  saveData('tk_timers', timers);
  recomputeSections();
  renderTimers();
}

function editInterval(mid,idx){
  const iv=timers[mid].intervals[idx]; if(!iv||!iv.end) return;
  const toIn=d=>`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  document.getElementById('modalTitle').textContent='Edit Interval';
  document.getElementById('modalBody').innerHTML=`
    <div class="edit-interval-row"><label>Start</label><input type="time" id="editStart" value="${toIn(new Date(iv.start))}" step="60"></div>
    <div class="edit-interval-row"><label>End</label><input type="time" id="editEnd" value="${toIn(new Date(iv.end))}" step="60"></div>
    <div style="margin-top:8px"><button class="entry-btn delete" onclick="deleteInterval('${mid}',${idx})">Delete Interval</button></div>`;
  document.getElementById('modalButtons').innerHTML=`
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveIvEdit('${mid}',${idx})">Save</button>`;
  document.getElementById('modal').classList.add('visible');
}

function saveIvEdit(mid,idx){
  const iv=timers[mid].intervals[idx];
  const sv=document.getElementById('editStart').value, ev=document.getElementById('editEnd').value;
  if(!sv||!ev){closeModal();return;}
  const[sh,sm]=sv.split(':').map(Number),[eh,em]=ev.split(':').map(Number);
  const ns=new Date(iv.start);ns.setHours(sh,sm,0,0);
  const ne=new Date(iv.end);ne.setHours(eh,em,0,0);
  if(ne<=ns){alert('End must be after start.');return;}
  iv.start=ns.getTime();iv.end=ne.getTime();
  saveData('tk_timers',timers);closeModal();renderTimers();
}

function deleteInterval(mid,idx){
  timers[mid].intervals.splice(idx,1);
  // If no intervals left, close panel and reset adjustment
  if (timers[mid].intervals.length === 0) {
    openIntervals[mid] = false;
    timers[mid].manualAdjustMs = 0;
  }
  saveData('tk_timers',timers);closeModal();renderTimers();
}

function isToday(ts){const d=new Date(ts),n=new Date();return d.getFullYear()===n.getFullYear()&&d.getMonth()===n.getMonth()&&d.getDate()===n.getDate();}

function renderToday(){
  const list=document.getElementById('entryList');
  if(!entries.length){list.innerHTML=`<div class="empty-state"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><p>No entries saved yet.</p></div>`;return;}

  // Group entries by date key (YYYY-MM-DD), sorted newest first
  const groups = {};
  entries.forEach(e => {
    const d = new Date(e.timestamp);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if (!groups[key]) groups[key] = [];
    groups[key].push(e);
  });
  const sortedKeys = Object.keys(groups).sort().reverse();

  let html = '';
  sortedKeys.forEach(key => {
    const dayEntries = groups[key];
    const dayTotal = dayEntries.reduce((s,e) => s + parseFloat(e.hours), 0);
    const d = new Date(key + 'T12:00:00');
    const today = new Date();
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
    let label;
    if (d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate()) {
      label = 'Today';
    } else if (d.getFullYear()===yesterday.getFullYear() && d.getMonth()===yesterday.getMonth() && d.getDate()===yesterday.getDate()) {
      label = 'Yesterday';
    } else {
      label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    const sectionKey = 'day_' + key;
    const dc = isSectionCollapsed(sectionKey);
    const todayBadge = label === 'Today' ?
      `<span style="font-weight:700;color:white;font-size:15px;text-transform:uppercase;letter-spacing:0.5px;background:linear-gradient(145deg,#2E9E55,#1B7A3D);padding:3px 10px;border-radius:10px">${label}</span>` :
      `<span style="font-weight:700;color:var(--text-secondary);font-size:16px;text-transform:uppercase;letter-spacing:1px">${label}</span>`;

    const chevron = `<span data-chevron style="font-size:30px;color:var(--text-muted);transition:transform 0.25s ease;display:inline-block;margin-left:10px;padding-left:6px;${dc?'transform:rotate(-90deg)':''}">▾</span>`;

    const entryCount = `<span class="section-count">${dayEntries.length}</span>`;

    html += `<div onclick="toggleSection('${sectionKey}',this)" style="padding:16px 4px 10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;-webkit-user-select:none;user-select:none">
      <div style="display:flex;align-items:center;gap:8px">${todayBadge}${entryCount}</div>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-family:var(--mono);font-size:16px;color:var(--accent);font-weight:600">${dayTotal.toFixed(2)} h</span>
        <button onclick="event.stopPropagation();exportDay('${key}')" style="background:var(--accent-light);border:1px solid var(--accent-mid);color:var(--accent);font-size:14px;font-weight:700;cursor:pointer;padding:5px 12px;border-radius:8px;font-family:var(--font)">Export</button>
        <div style="position:relative;display:inline-block" onclick="event.stopPropagation()">
          <button onclick="toggleDayMenu(this)" style="background:none;border:none;color:var(--text-muted);font-size:18px;font-weight:700;cursor:pointer;padding:0 4px;line-height:1;letter-spacing:2px">⋯</button>
          <div class="day-overflow-menu" style="display:none;position:absolute;right:0;top:100%;margin-top:4px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow);z-index:60;min-width:160px">
            <button onclick="this.closest('.day-overflow-menu').style.display='none';confirmClearDate('${key}')" style="display:block;width:100%;text-align:left;background:none;border:none;padding:12px 16px;font-size:15px;font-weight:600;color:var(--danger);cursor:pointer;font-family:var(--font)">Clear All Entries</button>
          </div>
        </div>${chevron}
      </div>
    </div>`;

    html += `<div class="section-content"${dc?' style="display:none"':''}>`;
    dayEntries.forEach(e => {
      const eb = e.timeEdited ? '<span class="entry-edited">edited</span>' : '';
      let intervalMs = 0;
      if(e.intervals&&e.intervals.length>0) e.intervals.forEach(iv=>{ if(iv.start&&iv.end) intervalMs+=(iv.end-iv.start); });
      const intervalRounded = parseFloat(fmtRound(intervalMs, e.increment||0.10));
      const hoursNum = parseFloat(e.hours)||0;
      const adjIncrements = Math.round((hoursNum - intervalRounded) / (e.increment||0.10));
      const minsPerInc = (e.increment||0.10)===0.25 ? 15 : 6;
      const intMin = Math.floor(intervalMs/60000);
      const intSec = Math.floor((intervalMs%60000)/1000);
      const adjMin = adjIncrements * minsPerInc;
      const totalMin = intMin + adjMin;
      const dispH = Math.floor(totalMin/60);
      const dispM = String(Math.abs(totalMin)%60).padStart(2,'0');
      const timeStr = totalMin > 0 ? `${dispH}:${dispM}` : `0:00`;
      html += `<div class="entry-card"><div class="entry-top"><span class="entry-matter">${e.matterName}</span><div style="text-align:right;flex-shrink:0;margin-left:12px"><span class="entry-time" style="margin-left:0">${e.hours} h${eb}</span><div style="font-size:16px;color:var(--text-secondary);font-family:var(--mono);margin-top:2px">${timeStr}</div></div></div><div class="entry-narrative ${e.narrative?'':'missing'}">${e.narrative||'No narrative — tap edit to add'}</div><div class="entry-actions" style="justify-content:space-between"><button onclick="confirmDeleteEntry('${e.id}')" style="background:none;border:none;color:var(--danger);font-size:16px;cursor:pointer;padding:4px 0;font-family:var(--font)">Delete</button><button class="entry-btn" onclick="editEntry('${e.id}')">Edit</button></div></div>`;
    });
    html += '</div>';
  });
  list.innerHTML = html;
}

function editEntry(id){
  const e=entries.find(x=>x.id===id); if(!e) return;
  const inc=e.increment||0.10, il=inc===0.25?'¼ hr':'⅒ hr';
  // Calculate raw interval total
  let intervalMs = 0;
  if(e.intervals&&e.intervals.length>0) e.intervals.forEach(iv=>{ if(iv.start&&iv.end) intervalMs+=(iv.end-iv.start); });
  const intervalRounded = fmtRound(intervalMs, inc);
  const hoursNum = parseFloat(e.hours) || 0;
  const diff = hoursNum - parseFloat(intervalRounded);
  let ivH='';
  if(e.intervals&&e.intervals.length>0) ivH=e.intervals.map(iv=>`<div class="edit-interval-readonly">${fmtClock(iv.start)} – ${fmtClock(iv.end)}  ·  ${fmtDur(iv.end-iv.start)}</div>`).join('');
  else ivH='<div class="edit-interval-readonly">No interval data</div>';
  // Summary line
  const intervalMin = Math.floor(intervalMs/60000);
  const intervalSec = Math.floor((intervalMs%60000)/1000);
  let summaryHtml = `<div style="font-size:14px;color:var(--text-secondary);margin-top:6px;line-height:1.5">Interval total: ${intervalMin}m ${intervalSec}s → ${intervalRounded}h`;
  if(Math.abs(diff) >= 0.005) {
    summaryHtml += `<br><span style="font-weight:600;color:${diff>0?'var(--accent)':'var(--danger)'}">Manual adjustment: ${diff>0?'+':''}${diff.toFixed(2)}h</span>`;
  }
  summaryHtml += '</div>';

  const entryDate = new Date(e.timestamp);
  const dateVal = `${entryDate.getFullYear()}-${String(entryDate.getMonth()+1).padStart(2,'0')}-${String(entryDate.getDate()).padStart(2,'0')}`;

  document.getElementById('modalTitle').textContent=`Edit · ${e.matterName}`;
  document.getElementById('modalBody').innerHTML=`
    <div class="edit-section-label">Narrative</div>
    <textarea class="edit-textarea" id="editNarrative">${e.narrative||''}</textarea>
    <div style="display:flex;gap:12px;align-items:flex-end">
      <div style="flex:1"><div class="edit-section-label">Hours</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 0">
          <button class="adjust-step-btn" onclick="stepEntryHours(-${inc})">−</button>
          <span class="adjust-display" id="editHoursDisp" onclick="directEditEntryHours(${inc})">${e.hours}</span>
          <button class="adjust-step-btn" onclick="stepEntryHours(${inc})">+</button>
        </div>
        <input type="hidden" id="editHours" value="${e.hours}">
      </div>
      <div style="flex:1"><div class="edit-section-label">Date</div>
        <input type="date" class="edit-time-input" id="editDate" value="${dateVal}" style="font-family:var(--font)"></div>
    </div>
    ${summaryHtml}
    <div class="edit-section-label">Intervals</div>${ivH}`;
  document.getElementById('modalButtons').innerHTML=`
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveEntryEdit('${id}')">Save</button>`;
  document.getElementById('modal').classList.add('visible');
}

function stepEntryHours(delta){
  const inp=document.getElementById('editHours');
  const disp=document.getElementById('editHoursDisp');
  if(!inp||!disp) return;
  let val=Math.round((parseFloat(inp.value)+delta)*100)/100;
  if(val<0) val=0;
  inp.value=val.toFixed(2);
  disp.textContent=val.toFixed(2);
}

function directEditEntryHours(inc) {
  const disp = document.getElementById('editHoursDisp');
  const hidden = document.getElementById('editHours');
  if (!disp || !hidden) return;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = inc.toFixed(2);
  input.value = hidden.value;
  input.className = 'adjust-display-input';
  input.inputMode = 'decimal';
  disp.replaceWith(input);
  input.focus();
  input.select();
  const commit = () => {
    let val = parseFloat(input.value);
    if (isNaN(val)) val = 0;
    if (val < 0) val = 0;
    val = Math.round(val * 100) / 100;
    hidden.value = val.toFixed(2);
    const span = document.createElement('span');
    span.className = 'adjust-display';
    span.id = 'editHoursDisp';
    span.textContent = val.toFixed(2);
    span.onclick = () => directEditEntryHours(inc);
    input.replaceWith(span);
  };
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } });
}

function saveEntryEdit(id){
  const e=entries.find(x=>x.id===id); if(!e){closeModal();return;}
  e.narrative=document.getElementById('editNarrative').value.trim();
  const ph=parseFloat(document.getElementById('editHours').value);
  if(!isNaN(ph)&&ph.toFixed(2)!==e.hours){e.hours=ph.toFixed(2);e.timeEdited=true;}
  // Handle date change: preserve time-of-day, change the date
  const newDateVal = document.getElementById('editDate').value;
  if (newDateVal) {
    const oldDate = new Date(e.timestamp);
    const [y,m,d] = newDateVal.split('-').map(Number);
    const newDate = new Date(oldDate);
    newDate.setFullYear(y, m-1, d);
    e.timestamp = newDate.getTime();
  }
  saveData('tk_entries',entries);closeModal();renderToday();
}

function confirmDeleteEntry(id){showModal('Delete Entry','Remove this time entry?',()=>{entries=entries.filter(e=>e.id!==id);saveData('tk_entries',entries);renderToday();});}

function getExportTextForDate(dateKey){
  const te = entries.filter(e => {
    const ed = new Date(e.timestamp);
    return `${ed.getFullYear()}-${String(ed.getMonth()+1).padStart(2,'0')}-${String(ed.getDate()).padStart(2,'0')}` === dateKey;
  });
  const d = new Date(dateKey + 'T12:00:00');
  const label = d.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  if(!te.length) return 'No entries for this date.';
  let t=`Time Entries — ${label}\n${'━'.repeat(40)}\n\n`;
  te.forEach(e=>{t+=`${e.matterName}\n${e.matterDetail}\nHours: ${e.hours}\nNarrative: ${e.narrative||'[NONE]'}\n\n`;});
  t+=`${'━'.repeat(40)}\nTotal: ${te.reduce((s,e)=>s+parseFloat(e.hours),0).toFixed(2)} hours\n`;
  return t;
}
function exportDay(dateKey){
  const text = getExportTextForDate(dateKey);
  document.getElementById('modalTitle').textContent = 'Export';
  document.getElementById('modalBody').innerHTML = `<pre style="font-family:var(--mono);font-size:14px;line-height:1.6;white-space:pre-wrap;color:var(--text);background:var(--surface-inset);padding:14px;border-radius:var(--radius-sm);border:1px solid var(--border-light);max-height:50vh;overflow-y:auto">${text}</pre>`;
  document.getElementById('modalButtons').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal()">Done</button>
    <button class="btn btn-primary" id="copyExportBtn" onclick="copyDayExport('${dateKey}')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="margin-right:4px"><rect x="6" y="6" width="8" height="8" rx="1"/><path d="M4 10H3.5a1.5 1.5 0 01-1.5-1.5v-5A1.5 1.5 0 013.5 2h5A1.5 1.5 0 0110 3.5V4"/></svg>
      Copy to Clipboard</button>`;
  document.getElementById('modal').classList.add('visible');
}
function copyDayExport(dateKey){
  navigator.clipboard.writeText(getExportTextForDate(dateKey)).then(()=>{
    const b=document.getElementById('copyExportBtn');
    b.innerHTML='✓ Copied'; setTimeout(()=>{ b.innerHTML='Copy to Clipboard'; },2000);
  });
}
function toggleDayMenu(btn){
  const menu = btn.nextElementSibling;
  const wasOpen = menu.style.display === 'block';
  document.querySelectorAll('.day-overflow-menu').forEach(m => m.style.display='none');
  if (!wasOpen) menu.style.display = 'block';
}
// Close overflow menus on outside tap
document.addEventListener('click', function(e) {
  if (!e.target.closest('.day-overflow-menu') && !e.target.closest('[onclick*="toggleDayMenu"]')) {
    document.querySelectorAll('.day-overflow-menu').forEach(m => m.style.display='none');
  }
  if (!e.target.closest('.card-menu') && !e.target.closest('.card-gear-btn')) {
    document.querySelectorAll('.card-menu').forEach(m => m.style.display='none');
    document.querySelectorAll('.matter-card.menu-open').forEach(c => c.classList.remove('menu-open'));
  }
  if (!e.target.closest('.swipe-actions') && !e.target.closest('.swipe-content')) {
    closeAllSwipes();
  }
});

function confirmClearDate(dateKey){
  const d = new Date(dateKey + 'T12:00:00');
  const label = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
  const count = entries.filter(e => {
    const ed = new Date(e.timestamp);
    return `${ed.getFullYear()}-${String(ed.getMonth()+1).padStart(2,'0')}-${String(ed.getDate()).padStart(2,'0')}` === dateKey;
  }).length;
  showModal('Clear Day', `Remove all ${count} entries for ${label}?`, () => {
    entries = entries.filter(e => {
      const ed = new Date(e.timestamp);
      return `${ed.getFullYear()}-${String(ed.getMonth()+1).padStart(2,'0')}-${String(ed.getDate()).padStart(2,'0')}` !== dateKey;
    });
    saveData('tk_entries', entries); renderToday();
  });
}


function renderSettings(){}

function editMatter(mid) {
  const m = matters.find(x => x.id === mid);
  if (!m) return;
  const inc = m.increment || 0.10;

  document.getElementById('modalTitle').textContent = 'Edit Matter';
  document.getElementById('modalBody').innerHTML = `
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <div style="flex:2"><div class="edit-section-label" style="margin-top:0">Client Name</div>
        <input type="text" class="edit-textarea" id="editClientName" value="${m.clientName || ''}" placeholder="Client name" style="min-height:auto;padding:10px 12px;font-size:15px"></div>
      <div style="flex:1"><div class="edit-section-label" style="margin-top:0">Client #</div>
        <input type="text" class="edit-textarea" id="editClientNumber" value="${m.clientNumber || ''}" placeholder="#" style="min-height:auto;padding:10px 12px;font-size:15px;font-family:var(--mono)"></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <div style="flex:2"><div class="edit-section-label">Matter Name</div>
        <input type="text" class="edit-textarea" id="editMatterName" value="${m.matterName || ''}" placeholder="Matter name" style="min-height:auto;padding:10px 12px;font-size:15px"></div>
      <div style="flex:1"><div class="edit-section-label">Matter #</div>
        <input type="text" class="edit-textarea" id="editMatterNumber" value="${m.matterNumber || ''}" placeholder="#" style="min-height:auto;padding:10px 12px;font-size:15px;font-family:var(--mono)"></div>
    </div>
    <div class="edit-section-label">Display Name</div>
    <input type="text" class="edit-textarea" id="editDisplayName" value="${m.name}" placeholder="Bold title shown on timer" style="min-height:auto;padding:10px 12px;font-size:15px;font-weight:600">
    <div class="edit-section-label">Billing Increment</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary inc-btn ${inc===0.10?'active':''}" onclick="this.classList.add('active');this.nextElementSibling.classList.remove('active');document.getElementById('editIncrement').value='0.10'" style="flex:1;justify-content:center">Tenths (0.1)</button>
      <button class="btn btn-secondary inc-btn ${inc===0.25?'active':''}" onclick="this.classList.add('active');this.previousElementSibling.classList.remove('active');document.getElementById('editIncrement').value='0.25'" style="flex:1;justify-content:center">Quarters (0.25)</button>
    </div>
    <input type="hidden" id="editIncrement" value="${inc}">`;

  document.getElementById('modalButtons').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button onclick="closeModal();confirmDeleteMatter('${mid}')" style="background:none;border:none;color:var(--danger);font-size:14px;font-weight:600;cursor:pointer;padding:10px">Delete</button>
    <button class="btn btn-primary" onclick="saveMatterEdit('${mid}')">Save</button>`;
  document.getElementById('modal').classList.add('visible');
}

function saveMatterEdit(mid) {
  const m = matters.find(x => x.id === mid);
  if (!m) { closeModal(); return; }

  const clientName = document.getElementById('editClientName').value.trim();
  const clientNumber = document.getElementById('editClientNumber').value.trim();
  const matterName = document.getElementById('editMatterName').value.trim();
  const matterNumber = document.getElementById('editMatterNumber').value.trim();
  const displayName = document.getElementById('editDisplayName').value.trim();
  const increment = parseFloat(document.getElementById('editIncrement').value) || 0.10;

  if (!displayName && !clientName) { closeModal(); return; }

  m.clientName = clientName;
  m.clientNumber = clientNumber;
  m.matterName = matterName;
  m.matterNumber = matterNumber;
  m.name = displayName || (matterName ? `${clientName} — ${matterName}` : clientName);
  m.increment = increment;

  // Rebuild detail line
  let detailParts = [];
  if (matterName) detailParts.push(matterName);
  if (clientNumber || matterNumber) {
    detailParts.push(`(${[clientNumber, matterNumber].filter(Boolean).join('-')})`);
  }
  m.detail = detailParts.join(' ');

  saveData('tk_matters', matters);
  closeModal();
  renderSettings();
  renderTimers();
}
let displayNameManuallyEdited = false;

function openAddMatter() {
  displayNameManuallyEdited = false;
  document.getElementById('modalTitle').textContent = 'New Matter';
  document.getElementById('modalBody').innerHTML = `
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <div style="flex:2"><div class="edit-section-label" style="margin-top:0">Client Name</div>
        <input type="text" class="edit-textarea" id="newClientName" placeholder="Client name" style="min-height:auto;padding:10px 12px;font-size:15px" oninput="updateDefaultDisplayName()"></div>
      <div style="flex:1"><div class="edit-section-label" style="margin-top:0">Client #</div>
        <input type="text" class="edit-textarea" id="newClientNumber" placeholder="#" style="min-height:auto;padding:10px 12px;font-size:15px;font-family:var(--mono)" oninput="updateDefaultDisplayName()"></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <div style="flex:2"><div class="edit-section-label">Matter Name</div>
        <input type="text" class="edit-textarea" id="newMatterName" placeholder="Matter name" style="min-height:auto;padding:10px 12px;font-size:15px" oninput="updateDefaultDisplayName()"></div>
      <div style="flex:1"><div class="edit-section-label">Matter #</div>
        <input type="text" class="edit-textarea" id="newMatterNumber" placeholder="#" style="min-height:auto;padding:10px 12px;font-size:15px;font-family:var(--mono)" oninput="updateDefaultDisplayName()"></div>
    </div>
    <div class="edit-section-label">Display Name <span style="font-weight:400">(auto-generated, edit to override)</span></div>
    <input type="text" class="edit-textarea" id="newDisplayName" placeholder="Client — Matter" style="min-height:auto;padding:10px 12px;font-size:15px;font-weight:600" oninput="displayNameManuallyEdited=true">
    <div class="edit-section-label">Billing Increment</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-secondary inc-btn active" onclick="this.classList.add('active');this.nextElementSibling.classList.remove('active');document.getElementById('newIncVal').value='0.10'" style="flex:1;justify-content:center">Tenths (0.1)</button>
      <button class="btn btn-secondary inc-btn" onclick="this.classList.add('active');this.previousElementSibling.classList.remove('active');document.getElementById('newIncVal').value='0.25'" style="flex:1;justify-content:center">Quarters (0.25)</button>
    </div>
    <input type="hidden" id="newIncVal" value="0.10">`;
  document.getElementById('modalButtons').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="addMatter()">Add Matter</button>`;
  document.getElementById('modal').classList.add('visible');
  setTimeout(() => { const inp = document.getElementById('newClientName'); if (inp) inp.focus(); }, 100);
}

function updateDefaultDisplayName() {
  if (displayNameManuallyEdited) return;
  const client = document.getElementById('newClientName').value.trim();
  const matter = document.getElementById('newMatterName').value.trim();
  const display = document.getElementById('newDisplayName');
  if (client && matter) display.value = `${client} — ${matter}`;
  else if (client) display.value = client;
  else if (matter) display.value = matter;
  else display.value = '';
}

function addMatter(){
  const clientName = document.getElementById('newClientName').value.trim();
  const clientNumber = document.getElementById('newClientNumber').value.trim();
  const matterName = document.getElementById('newMatterName').value.trim();
  const matterNumber = document.getElementById('newMatterNumber').value.trim();
  const displayName = document.getElementById('newDisplayName').value.trim();
  const increment = parseFloat(document.getElementById('newIncVal').value) || 0.10;

  if (!clientName) return;

  const name = displayName || (matterName ? `${clientName} — ${matterName}` : clientName);

  let detailParts = [];
  if (matterName) detailParts.push(matterName);
  if (clientNumber || matterNumber) {
    const numStr = [clientNumber, matterNumber].filter(Boolean).join('-');
    detailParts.push(`(${numStr})`);
  }
  const detail = detailParts.join(' ');

  const id = 'm' + Date.now();
  matters.push({ id, name, detail, clientName, clientNumber, matterName, matterNumber, increment });
  timers[id] = { running: false, narrative: '', intervals: [], manualAdjustMs: 0, lastUsed: 0 };
  saveData('tk_matters', matters); saveData('tk_timers', timers);
  closeModal();
  displayNameManuallyEdited = false;
  recomputeSections(); renderTimers();
}
function confirmDeleteMatter(mid){const m=matters.find(x=>x.id===mid);showModal('Remove Matter',`Remove "${m.name}"?`,()=>{matters=matters.filter(x=>x.id!==mid);delete timers[mid];saveData('tk_matters',matters);saveData('tk_timers',timers);recomputeSections();renderSettings();renderTimers();});}
function switchScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const idx={timers:0,today:1,settings:2};
  const titles={timers:'Timers',today:'Entries',settings:'Settings'};
  document.getElementById(name+'Screen').classList.add('active');
  document.querySelectorAll('.nav-btn')[idx[name]].classList.add('active');
  document.getElementById('screenTitle').textContent=titles[name];
  document.getElementById('addMatterBtn').style.display = name==='timers' ? 'flex' : 'none';
  if(name==='timers'){recomputeSections();renderTimers();}
  if(name==='today')renderToday(); if(name==='settings')renderCloudUI();
}

let modalCb=null;
function showModal(title,msg,onConfirm){
  document.getElementById('modalTitle').textContent=title;
  document.getElementById('modalBody').innerHTML=`<p>${msg}</p>`;
  document.getElementById('modalButtons').innerHTML=`<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-danger" id="modalConfirm">Confirm</button>`;
  document.getElementById('modal').classList.add('visible');
  modalCb=onConfirm;document.getElementById('modalConfirm').onclick=()=>{closeModal();if(modalCb)modalCb();};
}
function closeModal(){document.getElementById('modal').classList.remove('visible');}

setInterval(()=>{
  document.querySelectorAll('[data-timer]').forEach(el=>{const id=el.dataset.timer,inc=parseFloat(el.dataset.inc)||0.10,s=parseInt(el.dataset.saved)||0,el2=getElapsed(id);el.innerHTML=`${fmt(el2)}<span class="rounded-time">${fmtRound(el2,inc)} h</span><span style="display:block;font-size:15px;font-weight:600;font-family:var(--font);min-height:1.2em;${s?'color:var(--accent-mid)':'visibility:hidden'}">${s ? s+' saved' : '&nbsp;'}</span>`;});
  // Update day total on timers screen
  let dayHrs = entries.filter(e=>isToday(e.timestamp)).reduce((s,e)=>s+parseFloat(e.hours||0),0);
  matters.forEach(m=>{const t=timers[m.id];if(t&&t.intervals&&t.intervals.length>0){const el=getElapsed(m.id);if(el>0)dayHrs+=roundInc(el,m.increment||0.10);}});
  const bar=document.getElementById('dayTotalBar'),val=document.getElementById('dayTotalValue');
  if(dayHrs>0){val.textContent=dayHrs.toFixed(2)+' h';}else{val.textContent='0.00 h';}
},1000);

// ===== BACKUP SYSTEM =====

// Tier 1: Rolling 5-minute backups (3 slots)
let backupSlot = 0;
const BACKUP_SLOTS = 3;

function autoBackup() {
  const snapshot = {
    matters: matters,
    timers: timers,
    entries: entries,
    timestamp: Date.now()
  };
  saveData('tk_autobackup_' + backupSlot, snapshot);
  backupSlot = (backupSlot + 1) % BACKUP_SLOTS;

  // Tier 2: Hourly backups (kept for 48 hours)
  hourlyBackupCheck(snapshot);
}

// Hourly backup logic
function hourlyBackupCheck(snapshot) {
  const hourlyIndex = loadData('tk_hourly_index', []);
  const now = Date.now();
  const oneHourMs = 60 * 60 * 1000;
  const fortyEightHoursMs = 48 * oneHourMs;

  const currentHourStart = Math.floor(now / oneHourMs) * oneHourMs;
  const hasThisHour = hourlyIndex.some(h => h.hourKey === currentHourStart);

  if (!hasThisHour) {
    const key = 'tk_hourly_' + currentHourStart;
    saveData(key, snapshot);
    hourlyIndex.push({ hourKey: currentHourStart, storageKey: key, timestamp: now });

    const cutoff = now - fortyEightHoursMs;
    const keep = [];
    hourlyIndex.forEach(h => {
      if (h.timestamp >= cutoff) { keep.push(h); }
      else { localStorage.removeItem(h.storageKey); }
    });
    saveData('tk_hourly_index', keep);

    // Trigger cloud backup if connected
    cloudAutoUpload();
  }
}

setInterval(autoBackup, 5 * 60 * 1000);
autoBackup();

// Also backup on every save-entry (most critical moment)
const origSaveEntry = saveEntry;

// Crypto helpers using Web Crypto API (AES-GCM)
async function deriveKey(passphrase, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function encryptData(plaintext, passphrase) {
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase, salt);
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(plaintext));
  // Pack: salt (16) + iv (12) + ciphertext
  const packed = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
  packed.set(salt, 0);
  packed.set(iv, salt.length);
  packed.set(new Uint8Array(encrypted), salt.length + iv.length);
  // Base64 encode
  return btoa(String.fromCharCode(...packed));
}

async function decryptData(base64, passphrase) {
  const packed = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const salt = packed.slice(0, 16);
  const iv = packed.slice(16, 28);
  const ciphertext = packed.slice(28);
  const key = await deriveKey(passphrase, salt);
  const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ciphertext);
  return new TextDecoder().decode(decrypted);
}

function showBackupStatus(msg, type) {
  const el = document.getElementById('backupStatus');
  el.textContent = msg;
  el.className = 'backup-status visible' + (type ? ' ' + type : '');
  if (type === 'success') setTimeout(() => { el.className = 'backup-status'; }, 4000);
}

// Restore from auto-backup (emergency) — two-tier display
function restoreAutoBackup() {
  const recentSlots = [];
  const hourlySlots = [];

  // Gather 5-minute rolling backups
  for (let i = 0; i < BACKUP_SLOTS; i++) {
    const b = loadData('tk_autobackup_' + i, null);
    if (b && b.timestamp) recentSlots.push(b);
  }
  const legacy = loadData('tk_autobackup', null);
  if (legacy && legacy.timestamp) recentSlots.push(legacy);
  recentSlots.sort((a, b) => b.timestamp - a.timestamp);

  // Gather hourly backups
  const hourlyIndex = loadData('tk_hourly_index', []);
  hourlyIndex.forEach(h => {
    const b = loadData(h.storageKey, null);
    if (b && b.timestamp) hourlySlots.push(b);
  });
  hourlySlots.sort((a, b) => b.timestamp - a.timestamp);

  if (recentSlots.length === 0 && hourlySlots.length === 0) {
    showBackupStatus('No auto-backups found.', 'error');
    return;
  }

  function fmtAge(ts) {
    const mins = Math.floor((Date.now() - ts) / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ${mins % 60}m ago`;
    return `${Math.floor(hrs / 24)}d ${hrs % 24}h ago`;
  }

  function fmtTime(ts) {
    const d = new Date(ts);
    let h = d.getHours(); const ap = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12;
    return `${h}:${String(d.getMinutes()).padStart(2, '0')} ${ap}`;
  }

  function fmtDate(ts) {
    const d = new Date(ts), today = new Date();
    if (d.toDateString() === today.toDateString()) return 'Today';
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  // Combine all into one indexed list
  const all = [];
  recentSlots.forEach(s => all.push({ ...s, tier: 'recent' }));
  hourlySlots.forEach(s => all.push({ ...s, tier: 'hourly' }));
  window._backupSlots = all;

  function renderSlot(s, idx) {
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--surface-inset);border-radius:var(--radius-sm);margin-bottom:6px;border:1px solid var(--border)">
      <div>
        <div style="font-size:15px;font-weight:600;color:var(--text)">${fmtDate(s.timestamp)} ${fmtTime(s.timestamp)} <span style="font-size:13px;font-weight:500;color:var(--text-secondary)">· ${fmtAge(s.timestamp)}</span></div>
        <div style="font-size:14px;color:var(--text-secondary);margin-top:2px">${s.entries.length} entries · ${s.matters.length} matters</div>
      </div>
      <button class="btn btn-secondary" style="flex:none;padding:8px 14px;font-size:14px" onclick="previewBackupSlot(${idx})">View</button>
    </div>`;
  }

  let bodyHtml = '<p style="margin-bottom:14px">Choose a snapshot to view or restore.</p>';
  if (recentSlots.length > 0) {
    bodyHtml += '<div style="font-size:14px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Last 15 minutes</div>';
    const offset = 0;
    recentSlots.forEach((s, i) => { bodyHtml += renderSlot(all[offset + i], offset + i); });
  }
  if (hourlySlots.length > 0) {
    const offset = recentSlots.length;
    bodyHtml += '<div style="font-size:14px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin:12px 0 6px">Hourly (last 48 hours)</div>';
    hourlySlots.forEach((s, i) => { bodyHtml += renderSlot(all[offset + i], offset + i); });
  }

  document.getElementById('modalTitle').textContent = 'Backup Snapshots';
  document.getElementById('modalBody').innerHTML = bodyHtml;
  document.getElementById('modalButtons').innerHTML = `
    <button class="btn btn-secondary" style="flex:1;justify-content:center" onclick="closeModal()">Cancel</button>`;
  document.getElementById('modal').classList.add('visible');
}

function previewBackupSlot(idx) {
  const s = window._backupSlots[idx];
  if (!s) return;

  // Format entries from the snapshot
  const d = new Date(s.timestamp);
  const label = d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const time = d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });

  let text = `Backup Snapshot — ${label} ${time}\n${'━'.repeat(40)}\n\n`;

  // Show active/paused timers with time on them
  const activeTimers = s.matters.filter(m => {
    const t = s.timers[m.id];
    return t && (t.running || t.intervals.length > 0);
  });
  if (activeTimers.length > 0) {
    text += `ACTIVE TIMERS\n`;
    activeTimers.forEach(m => {
      const t = s.timers[m.id];
      let ms = 0;
      t.intervals.forEach(iv => { ms += (iv.end || s.timestamp) - iv.start; });
      ms = Math.max(0, ms + (t.manualAdjustMs || 0));
      const mins = Math.floor(ms / 60000);
      const secs = Math.floor((ms % 60000) / 1000);
      const status = t.running ? '▶ running' : '⏸ paused';
      const inc = m.increment || 0.10;
      const rounded = roundInc(ms, inc).toFixed(2);
      text += `${m.name} — ${mins}m ${secs}s (${rounded}h) ${status}\n`;
      if (t.narrative) text += `  Narrative: ${t.narrative}\n`;
    });
    text += `\n${'━'.repeat(40)}\n\n`;
  }

  if (s.entries.length === 0) {
    text += 'No saved entries in this snapshot.\n\n';
  } else {
    text += `SAVED ENTRIES\n`;
    s.entries.forEach(e => {
      text += `${e.matterName}\n${e.matterDetail || ''}\nHours: ${e.hours}\nNarrative: ${e.narrative || '[NONE]'}\n\n`;
    });
    text += `${'━'.repeat(40)}\nTotal: ${s.entries.reduce((sum, e) => sum + parseFloat(e.hours), 0).toFixed(2)} hours\n`;
  }

  text += `\n${s.matters.length} matters · ${s.entries.length} entries`;

  window._previewSlotIdx = idx;
  window._previewSlotText = text;

  document.getElementById('modalTitle').textContent = 'Backup Snapshot';
  document.getElementById('modalBody').innerHTML = `
    <pre style="font-family:var(--mono);font-size:14px;line-height:1.6;white-space:pre-wrap;color:var(--text);background:var(--surface-inset);padding:14px;border-radius:var(--radius-sm);border:1px solid var(--border-light);max-height:50vh;overflow-y:auto">${text}</pre>`;
  document.getElementById('modalButtons').innerHTML = `
    <button class="btn btn-secondary" onclick="closeModal();restoreAutoBackup()" style="flex:none">Back</button>
    <button class="btn btn-secondary" id="copySnapshotBtn" onclick="copySnapshotText()" style="flex:1;justify-content:center">Copy</button>
    <button class="btn btn-primary" onclick="confirmRestoreSlot(${idx})" style="flex:1;justify-content:center">Restore</button>`;
  document.getElementById('modal').classList.add('visible');
}

function copySnapshotText() {
  navigator.clipboard.writeText(window._previewSlotText).then(() => {
    const b = document.getElementById('copySnapshotBtn');
    b.textContent = '✓ Copied';
    setTimeout(() => { b.textContent = 'Copy'; }, 2000);
  });
}

function confirmRestoreSlot(idx) {
  const s = window._backupSlots[idx];
  if (!s) return;
  closeModal();
  showModal('Confirm Restore',
    `Replace all current data with this snapshot? (${s.entries.length} entries, ${s.matters.length} matters)`,
    () => {
      matters = s.matters;
      timers = s.timers;
      entries = s.entries;
      saveData('tk_matters', matters);
      saveData('tk_timers', timers);
      saveData('tk_entries', entries);
      recomputeSections();
      renderTimers();
      closeModal();
      showBackupStatus(`Restored ${s.entries.length} entries from snapshot.`, 'success');
    });
}

// ===== CLOUD BACKUP (DROPBOX) =====

const CLOUD_KEY = 'tk_cloud_config';

function getCloudConfig() { return loadData(CLOUD_KEY, null); }
function saveCloudConfig(cfg) { saveData(CLOUD_KEY, cfg); }

// PKCE helpers
function generateCodeVerifier() {
  const arr = new Uint8Array(32);
  crypto.getRandomValues(arr);
  return btoa(String.fromCharCode(...arr)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function generateCodeChallenge(verifier) {
  const enc = new TextEncoder();
  const digest = await crypto.subtle.digest('SHA-256', enc.encode(verifier));
  return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function showCloudStatus(msg, type) {
  const el = document.getElementById('cloudStatus');
  el.textContent = msg;
  el.className = 'backup-status visible' + (type ? ' ' + type : '');
  if (type === 'success') setTimeout(() => { el.className = 'backup-status'; }, 5000);
}

// Connect flow
async function cloudConnect() {
  const appKey = document.getElementById('cloudAppKey').value.trim();
  if (!appKey) { showCloudStatus('Enter your Dropbox App Key.', 'error'); return; }

  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // Store pending auth state
  saveData('tk_cloud_pending', { appKey, codeVerifier });

  // Open Dropbox auth in new tab
  const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${encodeURIComponent(appKey)}&response_type=code&code_challenge=${encodeURIComponent(codeChallenge)}&code_challenge_method=S256&token_access_type=offline`;

  // Show instructions and code input
  document.getElementById('cloudSetup').innerHTML = `
    <div style="font-size:15px;color:var(--text-secondary);line-height:1.6;margin-bottom:12px">
      A Dropbox authorization page has opened. After you approve access, Dropbox will show you a <strong>code</strong>. Copy it and paste it here:
    </div>
    <input type="text" id="cloudAuthCode" placeholder="Paste authorization code from Dropbox" autocomplete="off" style="font-family:var(--mono);font-size:14px">
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary" style="flex:1;justify-content:center" onclick="cloudFinishConnect()">Complete Setup</button>
      <button class="btn btn-secondary" style="flex:none" onclick="cloudCancelConnect()">Cancel</button>
    </div>
    <div style="margin-top:10px">
      <a href="${authUrl}" target="_blank" style="font-size:15px;color:var(--blue);font-weight:600;text-decoration:none">↗ Open Dropbox authorization page</a>
    </div>`;

  window.open(authUrl, '_blank');
}

async function cloudFinishConnect() {
  const code = document.getElementById('cloudAuthCode').value.trim();
  if (!code) { showCloudStatus('Paste the authorization code from Dropbox.', 'error'); return; }

  const pending = loadData('tk_cloud_pending', null);
  if (!pending) { showCloudStatus('Setup expired. Please start again.', 'error'); return; }

  showCloudStatus('Connecting to Dropbox…', '');

  try {
    // Exchange code for tokens
    const resp = await fetch('https://api.dropboxapi.com/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        code: code,
        grant_type: 'authorization_code',
        client_id: pending.appKey,
        code_verifier: pending.codeVerifier
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error_description || `HTTP ${resp.status}`);
    }

    const tokens = await resp.json();

    // Save config
    saveCloudConfig({
      appKey: pending.appKey,
      accessToken: tokens.access_token,
      refreshToken: tokens.refresh_token,
      tokenExpiry: Date.now() + (tokens.expires_in * 1000),
      lastUpload: 0
    });

    localStorage.removeItem('tk_cloud_pending');
    renderCloudUI();

    // Check for existing backups to offer restore
    try {
      const checkToken = await getValidAccessToken();
      if (checkToken) {
        const listResp = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${checkToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: '', recursive: false })
        });
        if (listResp.ok) {
          const listing = await listResp.json();
          const jsonFiles = (listing.entries || [])
            .filter(e => e['.tag'] === 'file' && e.name.startsWith('timekeeper-data-') && e.name.endsWith('.json'))
            .sort((a, b) => new Date(b.server_modified || 0) - new Date(a.server_modified || 0));
          if (jsonFiles.length > 0) {
            const newest = jsonFiles[0];
            const newestDate = new Date(newest.server_modified);
            const fmtD = newestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const fmtT = newestDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            document.getElementById('modalTitle').textContent = 'Backups Found';
            document.getElementById('modalBody').innerHTML = `<p style="font-size:16px;color:var(--text-secondary);line-height:1.6">Found ${jsonFiles.length} backup${jsonFiles.length > 1 ? 's' : ''} in Dropbox. The most recent is from <strong>${fmtD} at ${fmtT}</strong>.</p><p style="font-size:16px;color:var(--text-secondary);line-height:1.6;margin-top:8px">Would you like to restore from a backup?</p>`;
            document.getElementById('modalButtons').innerHTML = `<button class="btn btn-primary" onclick="closeModal();cloudRestore()">Choose a Backup</button><button class="btn btn-secondary" onclick="closeModal()">Skip — Start Fresh</button>`;
            document.getElementById('modal').classList.add('visible');
            return;
          }
        }
      }
    } catch (e) { console.warn('Backup check after connect failed:', e); }

    showCloudStatus('Connected! Hourly backups are now active.', 'success');

  } catch (err) {
    showCloudStatus('Connection failed: ' + err.message, 'error');
  }
}

function cloudCancelConnect() {
  localStorage.removeItem('tk_cloud_pending');
  renderCloudUI();
}

function cloudDisconnect() {
  showModal('Disconnect Dropbox', 'Stop automatic cloud backups? Existing backups in Dropbox will remain.', () => {
    localStorage.removeItem(CLOUD_KEY);
    localStorage.removeItem('tk_cloud_pending');
    showCloudStatus('Disconnected.', 'success');
    renderCloudUI();
  });
}

// Token refresh
async function getValidAccessToken() {
  const cfg = getCloudConfig();
  if (!cfg) return null;

  // Refresh if token expires within 5 minutes
  if (cfg.tokenExpiry && Date.now() > cfg.tokenExpiry - 300000) {
    try {
      const resp = await fetch('https://api.dropboxapi.com/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: cfg.refreshToken,
          client_id: cfg.appKey
        })
      });
      if (!resp.ok) throw new Error('Token refresh failed');
      const tokens = await resp.json();
      cfg.accessToken = tokens.access_token;
      cfg.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
      saveCloudConfig(cfg);
    } catch (err) {
      console.error('Cloud token refresh failed:', err);
      return null;
    }
  }

  return cfg.accessToken;
}

// Upload readable backup to Dropbox
// Guard: refuse to upload if data looks like fresh defaults
function hasRealData() {
  const realMatters = matters.filter(m => !m.taskLabel && m.clientNumber !== '000000');
  return realMatters.length > 0 || entries.length > 0;
}

async function cloudUploadBackup() {
  const cfg = getCloudConfig();
  if (!cfg) return false;

  if (!hasRealData()) { console.log('Cloud upload skipped: no real data'); return false; }

  const token = await getValidAccessToken();
  if (!token) return false;

  // Build readable text report
  const now = new Date();
  let lines = [];
  lines.push('BILLABLE BACKUP');
  lines.push(`Exported: ${now.toLocaleString()}`);
  lines.push('='.repeat(50));

  // Active timers
  const activeTimers = Object.keys(timers).filter(id => {
    const t = timers[id];
    return t.running || (t.intervals && t.intervals.length > 0);
  });
  if (activeTimers.length > 0) {
    lines.push('');
    lines.push('ACTIVE TIMERS');
    lines.push('-'.repeat(50));
    activeTimers.forEach(id => {
      const t = timers[id];
      const m = matters.find(x => x.id === id);
      if (!m) return;
      const el = getElapsed(id);
      const inc = m.increment || 0.10;
      const numberLine = [m.clientNumber, m.matterNumber].filter(Boolean).join('-');
      lines.push(`Matter: ${numberLine || 'No number'}`);
      lines.push(`  Status: ${t.running ? '▶ RUNNING' : '⏸ Paused'}`);
      lines.push(`  Elapsed: ${fmt(el)} | Rounded: ${fmtRound(el, inc)} h`);
      if (t.narrative) lines.push(`  Narrative: ${t.narrative}`);
      if (t.intervals && t.intervals.length > 0) {
        t.intervals.forEach(iv => {
          const s = new Date(iv.start).toLocaleTimeString();
          const e = iv.end ? new Date(iv.end).toLocaleTimeString() : 'now';
          lines.push(`  Interval: ${s} – ${e}`);
        });
      }
      lines.push('');
    });
  }

  // Saved entries grouped by date
  if (entries.length > 0) {
    lines.push('');
    lines.push('SAVED ENTRIES');
    lines.push('-'.repeat(50));
    // Group by date
    const byDate = {};
    entries.forEach(e => {
      const d = new Date(e.timestamp);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      if (!byDate[key]) byDate[key] = [];
      byDate[key].push(e);
    });
    Object.keys(byDate).sort().reverse().forEach(dateKey => {
      const d = new Date(dateKey + 'T12:00:00');
      lines.push(`\n${d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`);
      let dayTotal = 0;
      byDate[dateKey].forEach(e => {
        const hrs = parseFloat(e.hours) || 0;
        dayTotal += hrs;
        lines.push(`  ${e.billingNumber || 'No number'}${e.taskLabel ? ' [' + e.taskLabel + ']' : ''} | ${e.hours} h`);
        if (e.narrative) lines.push(`  Narrative: ${e.narrative}`);
        lines.push('');
      });
      lines.push(`  Day Total: ${dayTotal.toFixed(2)} h`);
    });
  }

  // Summary
  const totalHrs = entries.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
  lines.push('');
  lines.push('='.repeat(50));
  lines.push(`Total Saved Entries: ${entries.length}`);
  lines.push(`Total Hours: ${totalHrs.toFixed(2)}`);
  lines.push(`Matters: ${matters.length}`);

  const text = lines.join('\n');

  // File path with timestamp
  const dateStr = now.toISOString().slice(0, 13).replace(/T/, '-');
  const path = `/timekeeper-backup-${dateStr}.txt`;

  const resp = await fetch('https://content.dropboxapi.com/2/files/upload', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/octet-stream',
      'Dropbox-API-Arg': JSON.stringify({
        path: path,
        mode: 'overwrite',
        mute: true
      })
    },
    body: new TextEncoder().encode(text)
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error_summary || `Upload failed: ${resp.status}`);
  }

  // Update last upload time
  cfg.lastUpload = Date.now();
  saveCloudConfig(cfg);

  // JSON data backup every hour (alongside text)
  const lastJsonUpload = cfg.lastJsonUpload || 0;
  if (Date.now() - lastJsonUpload > 60 * 60 * 1000) {
    await cloudUploadJsonBackup(token, cfg);
  }

  return true;
}

async function cloudUploadJsonBackup(token, cfg) {
  if (!hasRealData()) { console.log('JSON backup skipped: no real data'); return; }
  try {
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 13).replace('T', '-'); // YYYY-MM-DD-HH
    const jsonData = JSON.stringify({ matters, timers, entries, exportedAt: now.toISOString() });
    const jsonPath = `/timekeeper-data-${dateStr}.json`;
    const resp = await fetch('https://content.dropboxapi.com/2/files/upload', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/octet-stream',
        'Dropbox-API-Arg': JSON.stringify({ path: jsonPath, mode: 'overwrite', mute: true })
      },
      body: new TextEncoder().encode(jsonData)
    });
    if (resp.ok) {
      cfg.lastJsonUpload = Date.now();
      saveCloudConfig(cfg);
    }
  } catch (err) { console.warn('JSON backup upload failed:', err); }
}

// Prune old cloud backups: text by 48h, JSON tiered (all hourly 48h + 1/day 14 days)
async function cloudPruneOld() {
  const token = await getValidAccessToken();
  if (!token) return;

  try {
    const listResp = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: '', recursive: false })
    });

    if (!listResp.ok) return;
    const listing = await listResp.json();

    const cutoff = new Date(Date.now() - 48 * 60 * 60 * 1000);
    const toDelete = [];

    // Text backups: prune by age (48h)
    (listing.entries || []).forEach(entry => {
      if (entry['.tag'] === 'file' && (entry.name.startsWith('timekeeper-backup-') || entry.name.startsWith('backup-'))) {
        const match = entry.name.match(/(?:timekeeper-)?backup-(\d{4})-(\d{2})-(\d{2})-(\d{2})/);
        if (match) {
          const fileDate = new Date(`${match[1]}-${match[2]}-${match[3]}T${match[4]}:00:00Z`);
          if (fileDate < cutoff) toDelete.push(entry.path_lower);
        }
      }
    });

    // JSON data backups: tiered retention
    // - Keep all hourly for 48h
    // - Keep one per day for 14 days
    // - Delete everything older
    const now = Date.now();
    const hourCutoff = now - 48 * 60 * 60 * 1000;
    const dayCutoff = now - 14 * 24 * 60 * 60 * 1000;
    const jsonFiles = (listing.entries || [])
      .filter(e => e['.tag'] === 'file' && e.name.startsWith('timekeeper-data-') && e.name.endsWith('.json'))
      .sort((a, b) => new Date(b.server_modified || 0) - new Date(a.server_modified || 0));

    const keptDays = new Set(); // track which days we've kept one for
    jsonFiles.forEach(f => {
      const fileDate = f.server_modified ? new Date(f.server_modified).getTime() : 0;
      if (!fileDate) return;
      const dayKey = new Date(f.server_modified).toLocaleDateString('en-CA');

      if (fileDate >= hourCutoff) {
        // Within 48h — keep all
        return;
      } else if (fileDate >= dayCutoff) {
        // Within 14 days — keep one per day (newest, since sorted desc)
        if (!keptDays.has(dayKey)) {
          keptDays.add(dayKey);
          return;
        }
      }
      // Older than 14 days or duplicate day — delete
      toDelete.push(f.path_lower);
    });

    for (const path of toDelete) {
      await fetch('https://api.dropboxapi.com/2/files/delete_v2', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: path })
      });
    }
  } catch (err) {
    console.error('Cloud prune failed:', err);
  }
}

// Auto-upload — called from hourlyBackupCheck
async function cloudAutoUpload() {
  const cfg = getCloudConfig();
  if (!cfg || !cfg.refreshToken) return;

  try {
    await cloudUploadBackup();
    await cloudPruneOld();
    // Update UI if settings screen is visible
    renderCloudUI();
  } catch (err) {
    console.error('Cloud auto-upload failed:', err);
  }
}

// Manual upload
async function cloudUploadNow() {
  const cfg = getCloudConfig();
  if (!cfg) return;
  if (!hasRealData()) {
    showCloudStatus('Upload skipped — only sample data detected. Restore your real data first.', 'error');
    return;
  }
  showCloudStatus('Uploading…', '');
  try {
    await cloudUploadBackup();
    // Manual upload always includes JSON data backup
    const token = await getValidAccessToken();
    if (token) await cloudUploadJsonBackup(token, cfg);
    await cloudPruneOld();
    showCloudStatus('Backup uploaded to Dropbox.', 'success');
    renderCloudUI();
  } catch (err) {
    showCloudStatus('Upload failed: ' + err.message, 'error');
  }
}

async function cloudRestore() {
  const token = await getValidAccessToken();
  if (!token) {
    document.getElementById('modalTitle').textContent = 'Connection Error';
    document.getElementById('modalBody').innerHTML = '<p>Could not connect to Dropbox. Please check your connection and try again.</p>';
    document.getElementById('modalButtons').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">OK</button>';
    document.getElementById('modal').classList.add('visible');
    return;
  }

  try {
    const listResp = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: '', recursive: false })
    });
    if (!listResp.ok) throw new Error('Could not list Dropbox files');
    const listing = await listResp.json();

    const jsonFiles = (listing.entries || [])
      .filter(e => e['.tag'] === 'file' && e.name.startsWith('timekeeper-data-') && e.name.endsWith('.json'))
      .sort((a, b) => new Date(b.server_modified || 0) - new Date(a.server_modified || 0));

    const txtFiles = (listing.entries || [])
      .filter(e => e['.tag'] === 'file' && e.name.startsWith('timekeeper-backup-') && e.name.endsWith('.txt'))
      .sort((a, b) => new Date(b.server_modified || 0) - new Date(a.server_modified || 0));

    if (jsonFiles.length === 0) {
      document.getElementById('modalTitle').textContent = 'No Restorable Backups';
      let msg = '<p>No JSON data backups found in Dropbox.</p>';
      if (txtFiles.length > 0) msg += `<p style="font-size:15px;color:var(--text-secondary)">${txtFiles.length} text backup(s) found, but these are read-only and can't be restored from automatically.</p>`;
      document.getElementById('modalBody').innerHTML = msg;
      document.getElementById('modalButtons').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">OK</button>';
      document.getElementById('modal').classList.add('visible');
      return;
    }

    // Store files for later use and show picker
    window._cloudRestoreFiles = jsonFiles;
    window._cloudRestoreToken = token;

    let listHtml = '<div style="max-height:300px;overflow-y:auto">';
    let currentDay = '';
    jsonFiles.forEach((f, i) => {
      // Use Dropbox's server_modified for exact time, fall back to filename
      const d = f.server_modified ? new Date(f.server_modified) : null;
      let timeLabel = '';
      let dayKey = '';
      let dayLabel = '';
      if (d && !isNaN(d)) {
        dayKey = d.toLocaleDateString('en-CA'); // YYYY-MM-DD local
        dayLabel = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        timeLabel = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      } else {
        const match = f.name.match(/data-(\d{4})-(\d{2})-(\d{2})(?:-(\d{2}))?/);
        if (match) {
          const hr = match[4] || '00';
          const fb = new Date(`${match[1]}-${match[2]}-${match[3]}T${hr}:00:00Z`);
          dayKey = fb.toLocaleDateString('en-CA');
          dayLabel = fb.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
          timeLabel = match[4] ? fb.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'Daily backup';
        }
      }
      if (dayKey && dayKey !== currentDay) {
        currentDay = dayKey;
        listHtml += `<div style="font-size:14px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;padding:${i > 0 ? '10px' : '0'} 0 6px">${dayLabel}</div>`;
      }
      const sizeKb = f.size ? (f.size / 1024).toFixed(1) + ' KB' : '';
      listHtml += `<button onclick="cloudRestorePick(${i})" style="display:block;width:100%;text-align:left;background:none;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:6px;cursor:pointer;font-family:var(--font)">
        <div style="font-size:15px;font-weight:600;color:var(--text)">${timeLabel || f.name}</div>
        <div style="font-size:14px;color:var(--text-secondary);margin-top:2px">${sizeKb || ''}</div>
      </button>`;
    });
    listHtml += '</div>';

    document.getElementById('modalTitle').textContent = 'Restore from Cloud';
    document.getElementById('modalBody').innerHTML = `<p style="font-size:15px;color:var(--text-secondary);margin-bottom:12px">Select a backup to restore:</p>${listHtml}`;
    document.getElementById('modalButtons').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>';
    document.getElementById('modal').classList.add('visible');

  } catch (err) {
    document.getElementById('modalTitle').textContent = 'Restore Failed';
    document.getElementById('modalBody').innerHTML = `<p style="color:var(--danger)">${err.message}</p>`;
    document.getElementById('modalButtons').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">OK</button>';
    document.getElementById('modal').classList.add('visible');
  }
}

async function cloudRestorePick(idx) {
  const file = window._cloudRestoreFiles[idx];
  const token = window._cloudRestoreToken;
  if (!file || !token) return;

  try {
    document.getElementById('modalBody').innerHTML = '<p style="color:var(--text-secondary)">Downloading backup…</p>';
    document.getElementById('modalButtons').innerHTML = '';

    const dlResp = await fetch('https://content.dropboxapi.com/2/files/download', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Dropbox-API-Arg': JSON.stringify({ path: file.path_lower })
      }
    });
    if (!dlResp.ok) throw new Error('Could not download backup');
    const data = JSON.parse(await dlResp.text());

    const mCount = (data.matters || []).length;
    const eCount = (data.entries || []).length;
    const activeCount = Object.values(data.timers || {}).filter(t => t.intervals && t.intervals.length > 0).length;
    const matterNames = (data.matters || []).filter(m => !m.taskLabel).map(m => m.name).join(', ');

    let dateLabel = file.name;
    if (file.server_modified) {
      const d = new Date(file.server_modified);
      dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    } else {
      const match = file.name.match(/data-(\d{4})-(\d{2})-(\d{2})(?:-(\d{2}))?/);
      if (match) {
        const hr = match[4] || '00';
        const d = new Date(`${match[1]}-${match[2]}-${match[3]}T${hr}:00:00Z`);
        dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      }
    }

    document.getElementById('modalTitle').textContent = 'Confirm Restore';
    document.getElementById('modalBody').innerHTML = `
      <p style="font-weight:600">${dateLabel}</p>
      <div style="font-size:15px;color:var(--text-secondary);line-height:1.7;margin-top:8px">
        <strong>${mCount}</strong> matters · <strong>${eCount}</strong> saved entries · <strong>${activeCount}</strong> active timers
        ${matterNames ? `<div style="margin-top:6px;font-size:14px;color:var(--text-secondary)">Matters: ${matterNames}</div>` : ''}
      </div>
      <p style="font-size:15px;color:var(--danger);margin-top:10px;font-weight:600">This will replace all current data.</p>`;
    document.getElementById('modalButtons').innerHTML = `
      <button class="btn btn-secondary" onclick="cloudRestore()">Back</button>
      <button class="btn btn-danger" onclick="cloudRestoreConfirm()">Restore</button>`;

    window._cloudRestoreData = data;
    window._cloudRestoreMCount = mCount;
    window._cloudRestoreECount = eCount;

  } catch (err) {
    document.getElementById('modalBody').innerHTML = `<p style="color:var(--danger)">Download failed: ${err.message}</p>`;
    document.getElementById('modalButtons').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">OK</button>';
  }
}

function cloudRestoreConfirm() {
  const data = window._cloudRestoreData;
  if (!data) return;
  const mCount = window._cloudRestoreMCount;
  const eCount = window._cloudRestoreECount;

  matters = data.matters || [];
  timers = data.timers || {};
  entries = data.entries || [];
  saveData('tk_matters', matters);
  saveData('tk_timers', timers);
  saveData('tk_entries', entries);
  recomputeSections();
  renderTimers();
  renderToday();
  renderSettings();
  closeModal();

  document.getElementById('modalTitle').textContent = '✓ Restore Complete';
  document.getElementById('modalBody').innerHTML = `<p style="color:var(--accent);font-weight:600">${mCount} matters and ${eCount} entries restored.</p>`;
  document.getElementById('modalButtons').innerHTML = `<button class="btn btn-primary" onclick="closeModal()">Done</button>`;
  document.getElementById('modal').classList.add('visible');

  // Clean up
  delete window._cloudRestoreFiles;
  delete window._cloudRestoreToken;
  delete window._cloudRestoreData;
  delete window._cloudRestoreMCount;
  delete window._cloudRestoreECount;
}

// UI state
function renderCloudUI() {
  const cfg = getCloudConfig();
  const connected = cfg && cfg.refreshToken;
  const connectedEl = document.getElementById('cloudConnected');
  const setupEl = document.getElementById('cloudSetup');

  if (!connectedEl || !setupEl) return;

  if (connected) {
    connectedEl.style.display = 'block';
    setupEl.style.display = 'none';
    const lastSync = document.getElementById('cloudLastSync');
    if (cfg.lastUpload) {
      const mins = Math.floor((Date.now() - cfg.lastUpload) / 60000);
      const ago = mins < 1 ? 'just now' : mins < 60 ? `${mins}m ago` : `${Math.floor(mins/60)}h ${mins%60}m ago`;
      lastSync.textContent = `Last upload: ${ago}.`;
    }
  } else {
    connectedEl.style.display = 'none';
    setupEl.style.display = 'block';
  }
}

recomputeSections();
renderTimers();
renderCloudUI();
// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').catch(() => {});
}
</script>
</body>
</html>
